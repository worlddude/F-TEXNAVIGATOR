<script>
const video = document.getElementById('video');
const numbersDiv = document.getElementById('numbers');
const addBtn = document.getElementById('addBtn');
const addForm = document.getElementById('addForm');
const saveBtn = document.getElementById('saveBtn');
const itemNameInput = document.getElementById('itemName');
const itemPriceInput = document.getElementById('itemPrice');

// For smoothing barcode readings
let detectedCodes = {};
const stableThreshold = 3; 
const displayDuration = 2000; 
let lastDisplayTime = 0;

let barcodeDB = {};
let currentCode = null;

// ==========================
// 🔧 CONFIG (for your repo)
// ==========================
const GITHUB_USERNAME = "worlddude";
const GITHUB_REPO = "F-TEXNAVIGATOR";
const FILE_PATH = "barcodes.json"; // make sure it's lowercase in repo
const BRANCH = "main";
const TOKEN = "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"; // ⚠️ your GitHub token

const API_URL = `https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${FILE_PATH}`;

// Load DB from GitHub Pages
async function loadDatabase() {
  try {
    const res = await fetch(`https://${GITHUB_USERNAME}.github.io/${GITHUB_REPO}/${FILE_PATH}`);
    if (!res.ok) throw new Error("barcodes.json not found, using empty DB");
    barcodeDB = await res.json();
    console.log("✅ Database loaded", barcodeDB);
  } catch (err) {
    console.warn("⚠️ Could not load database, starting empty:", err);
    barcodeDB = {};
  }
}

// Save new barcode entry to GitHub
async function saveToGitHub(newCode, newItem) {
  try {
    // Step 1: get latest file + SHA
    const res = await fetch(API_URL, {
      headers: { Authorization: `token ${TOKEN}` }
    });
    const fileData = await res.json();
    const sha = fileData.sha;

    // Step 2: parse current JSON
    let db = {};
    try {
      db = JSON.parse(atob(fileData.content));
    } catch (err) {
      console.error("Error parsing existing JSON:", err);
    }

    // Step 3: add new entry
    db[newCode] = newItem;

    // Step 4: commit update back to GitHub
    const updateRes = await fetch(API_URL, {
      method: "PUT",
      headers: {
        Authorization: `token ${TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: `Add barcode ${newCode}`,
        content: btoa(JSON.stringify(db, null, 2)),
        sha: sha,
        branch: BRANCH
      })
    });

    if (updateRes.ok) {
      alert("✅ Saved to GitHub!");
    } else {
      const errText = await updateRes.text();
      console.error("GitHub error:", errText);
      alert("❌ Failed to save to GitHub. Check console.");
    }
  } catch (err) {
    console.error("Error saving to GitHub:", err);
    alert("❌ Error saving to GitHub.");
  }
}

// Start camera
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    startScanner();
  } catch (err) {
    alert('Error accessing camera: ' + err.message);
  }
}

// Quagga init
function startScanner() {
  Quagga.init({
    inputStream: {
      name: 'Live',
      type: 'LiveStream',
      target: video,
      constraints: { width: 640, height: 480, facingMode: 'environment' }
    },
    locator: { patchSize: 'medium', halfSample: true },
    decoder: { readers: ['code_128_reader','ean_reader','ean_8_reader','code_39_reader','code_39_vin_reader','codabar_reader','upc_reader','upc_e_reader','i2of5_reader'] },
    locate: true,
    numOfWorkers: 0
  }, err => {
    if (err) { console.error('Error initializing Quagga:', err); return; }
    Quagga.start();
  });

  Quagga.onDetected(result => {
    const code = result.codeResult.code;
    const now = Date.now();

    detectedCodes[code] = (detectedCodes[code] || 0) + 1;
    for (let c in detectedCodes) {
      if (c !== code && now - lastDisplayTime > displayDuration) delete detectedCodes[c];
    }

    if (detectedCodes[code] >= stableThreshold) {
      currentCode = code;
      let message = `Detected Barcode: ${code}`;
      if (barcodeDB[code]) {
        const item = barcodeDB[code];
        message += `\nItem: ${item.name}\nPrice: $${item.price}`;
        addBtn.style.display = "none";
        addForm.style.display = "none";
      } else {
        message += "\n❌ Not found in database.";
        addBtn.style.display = "block"; // always show Add button if unknown
      }
      numbersDiv.textContent = message;
      lastDisplayTime = now;
      detectedCodes = {};
    }
  });
}

// Add item flow
addBtn.addEventListener("click", () => {
  addForm.style.display = "flex";
  itemNameInput.value = "";
  itemPriceInput.value = "";
});

saveBtn.addEventListener("click", async () => {
  const name = itemNameInput.value.trim();
  const price = parseFloat(itemPriceInput.value);
  if (!name || isNaN(price)) {
    alert("Please enter valid name and price.");
    return;
  }

  const newItem = { name, price };
  await saveToGitHub(currentCode, newItem);

  barcodeDB[currentCode] = newItem;
  numbersDiv.textContent = `✅ Added to GitHub!\nDetected Barcode: ${currentCode}\nItem: ${name}\nPrice: $${price}`;

  addForm.style.display = "none";
  addBtn.style.display = "none";
});

// Stop camera when tab hidden
document.addEventListener('visibilitychange', () => {
  if (document.hidden && video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
  }
});

window.addEventListener('load', async () => {
  await loadDatabase();
  startCamera();
});
</script>

