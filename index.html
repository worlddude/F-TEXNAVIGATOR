<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barcode Scanner</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: start;
      padding: 16px;
    }
    .card {
      background: #111827;
      border-radius: 16px;
      padding: 16px;
      max-width: 640px;
      width: 100%;
      box-shadow: 0 10px 25px rgba(0,0,0,.3);
    }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    p { color: #9ca3af; margin: 8px 0 16px; }
    video { width: 100%; border-radius: 12px; background: #000; }
    button {
      appearance: none;
      border: 1px solid #334155;
      background: #0b1220;
      color: #e5e7eb;
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 14px;
      cursor: pointer;
    }
    button.primary { background: #064e3b; border-color: #065f46; }
    button.danger { background: #3f0b0b; border-color: #7f1d1d; }
    .result {
      margin-top: 12px;
      background: #0b1220;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 12px;
      font-family: monospace;
      word-break: break-all;
    }
    .footer { color: #9ca3af; font-size: 12px; text-align: center; margin-top: 10px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@v4.1.1/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="card">
    <h1>üì¶ Barcode Scanner</h1>
    <p>Point your camera at a barcode (EAN-13 supported) and see the value below.</p>

    <video id="video" playsinline muted autoplay></video>

    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap">
      <button id="start" class="primary">‚ñ∂Ô∏è Start camera</button>
      <button id="stop" class="danger" disabled>‚èπÔ∏è Stop</button>
      <button id="snap">üì∏ Scan Number</button>
      <button id="copy" disabled>üìã Copy</button>
    </div>

    <div class="result" id="result">No code yet</div>
    <div class="footer">Runs fully in your browser. Works best over HTTPS (GitHub Pages).</div>
  </div>

  <script>
    const video = document.getElementById('video');
    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const snapBtn = document.getElementById('snap');
    const copyBtn = document.getElementById('copy');
    const resultDiv = document.getElementById('result');

    let stream = null;

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        startBtn.disabled = true;
        stopBtn.disabled = false;
      } catch (err) {
        alert('Error accessing camera: ' + err.message);
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      video.srcObject = null;
      startBtn.disabled = false;
      stopBtn.disabled = true;
      resultDiv.textContent = 'No code yet';
      copyBtn.disabled = true;
    }

    // EAN-13 checksum validator
    function validateEAN13(code) {
      if (!/^\d{13}$/.test(code)) return false;
      const digits = code.split('').map(Number);
      const sumOdd = digits.slice(0,12).filter((_,i)=>i%2===0).reduce((a,b)=>a+b,0);
      const sumEven = digits.slice(0,12).filter((_,i)=>i%2===1).reduce((a,b)=>a+b,0);
      const checksum = (10 - ((sumOdd + sumEven*3) % 10)) % 10;
      return checksum === digits[12];
    }

    async function scanNumber() {
      if (!stream) return alert('Start the camera first!');
      resultDiv.textContent = 'Scanning...';

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      try {
        const { data: { text } } = await Tesseract.recognize(canvas, 'eng', { 
          tessedit_char_whitelist: '0123456789'
        });
        const cleaned = text.replace(/\D/g, '').slice(0,13); // Take only first 13 digits
        if (cleaned.length < 13) {
          resultDiv.textContent = `Detected: ${cleaned} ‚ùå Too short`;
          copyBtn.disabled = true;
        } else {
          const valid = validateEAN13(cleaned);
          resultDiv.textContent = `Value: ${cleaned} ${valid ? '‚úÖ Valid' : '‚ùå Invalid'}`;
          copyBtn.disabled = !valid;
        }
      } catch (err) {
        console.error(err);
        resultDiv.textContent = 'OCR failed';
      }
    }

    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    snapBtn.addEventListener('click', scanNumber);
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(resultDiv.textContent);
        copyBtn.textContent = '‚úÖ Copied';
        setTimeout(() => copyBtn.textContent = 'üìã Copy', 1200);
      } catch {}
    });

    document.addEventListener('visibilitychange', () => { if (document.hidden) stopCamera(); });
  </script>
</body>
</html>
