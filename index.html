<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Camera Preview with Barcode Scanning</title>
<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  display: flex;
  justify-content: center;
  align-items: start;
  padding: 16px;
}
.card {
  background: #111827;
  border-radius: 16px;
  padding: 16px;
  max-width: 640px;
  width: 100%;
  box-shadow: 0 10px 25px rgba(0,0,0,.3);
}
h1 { font-size: 1.25rem; margin: 0 0 8px; }
p { color: #9ca3af; margin: 8px 0 16px; }
video { width: 100%; border-radius: 12px; background: #000; }
#numbers {
  margin-top: 10px;
  font-size: 18px;
  color: #22c55e;
  word-break: break-all;
}
#itemForm {
  margin-top: 10px;
}
#itemForm input {
  padding: 6px;
  border-radius: 6px;
  border: none;
  margin-right: 6px;
}
#itemForm button {
  padding: 6px 12px;
  border-radius: 6px;
  border: none;
  background: #2563eb;
  color: #fff;
  cursor: pointer;
}
.footer { color: #9ca3af; font-size: 12px; text-align: center; margin-top: 10px; }
</style>

<!-- QuaggaJS library for barcode scanning -->
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

</head>
<body>
<div class="card">
  <h1>ðŸ“· Camera Preview</h1>
  <p>The camera feed will start automatically. Barcode numbers will appear below when detected.</p>
  <video id="video" playsinline autoplay muted></video>
  <div id="numbers">Detected barcode numbers will appear here...</div>

  <div id="itemForm" style="display:none;">
    <input type="text" id="itemName" placeholder="Enter item name" />
    <button id="addBtn">Add</button>
  </div>

  <div class="footer">Your camera feed runs in the browser. Works best over HTTPS.</div>
</div>

<script>
const video = document.getElementById('video');
const numbersDiv = document.getElementById('numbers');
const itemForm = document.getElementById('itemForm');
const itemNameInput = document.getElementById('itemName');
const addBtn = document.getElementById('addBtn');

// Stable barcode scanning variables
let detectedCodes = {};
const stableThreshold = 3; // must appear 3 times
const displayDuration = 2000; // 2 seconds
let lastDisplayTime = 0;
let lastScannedCode = null;

// Start camera automatically
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    startScanner();
  } catch (err) {
    alert('Error accessing camera: ' + err.message);
  }
}

// Initialize QuaggaJS
function startScanner() {
  Quagga.init({
    inputStream: {
      name: 'Live',
      type: 'LiveStream',
      target: video,
      constraints: { width: 640, height: 480, facingMode: 'environment' }
    },
    locator: {
      patchSize: 'medium',
      halfSample: true
    },
    decoder: {
      readers: [
        'code_128_reader', 'ean_reader', 'ean_8_reader', 
        'code_39_reader', 'code_39_vin_reader', 'codabar_reader', 
        'upc_reader', 'upc_e_reader', 'i2of5_reader'
      ]
    },
    locate: true,
    numOfWorkers: 0
  }, function(err) {
    if (err) { console.error('Quagga init error:', err); return; }
    Quagga.start();
  });

  Quagga.onDetected(function(result) {
    const code = result.codeResult.code;
    const now = Date.now();

    // Count occurrences
    detectedCodes[code] = (detectedCodes[code] || 0) + 1;

    // Clean old codes
    for (let c in detectedCodes) {
      if (c !== code && now - lastDisplayTime > displayDuration) delete detectedCodes[c];
    }

    // Show stable code
    if (detectedCodes[code] >= stableThreshold) {
      numbersDiv.textContent = `Detected Barcode: ${code}`;
      lastDisplayTime = now;
      detectedCodes = {};
      lastScannedCode = code;
      itemForm.style.display = 'block';
    }
  });
}

// Add button click
addBtn.addEventListener('click', async () => {
  const itemName = itemNameInput.value.trim();
  if (!itemName || !lastScannedCode) return;

  const date = new Date().toISOString();
  const content = { barcode: lastScannedCode, name: itemName, date: date };
  const jsonData = JSON.stringify(content, null, 2);

  // GitHub API example â€” replace with your own info
  const githubToken = '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';
  const repoOwner = 'worlddude';
  const repoName = 'barcode-inventory';
  const path = `scanned_items/${lastScannedCode}.json`;

  try {
    const response = await fetch(`https://api.github.com/repos/${repoOwner}/${repoName}/contents/${path}`, {
      method: 'PUT',
      headers: {
        Authorization: `token ${githubToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: `Add item ${lastScannedCode}`,
        content: btoa(jsonData)
      })
    });
    const result = await response.json();
    alert('Item saved to GitHub!');
    itemForm.style.display = 'none';
    itemNameInput.value = '';
  } catch (err) {
    console.error(err);
    alert('Failed to save item to GitHub.');
  }
});

// Stop camera when tab hidden
document.addEventListener('visibilitychange', () => {
  if (document.hidden && video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
});

window.addEventListener('load', startCamera);
</script>
</body>
</html>
