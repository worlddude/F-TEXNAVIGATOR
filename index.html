<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Barcode Inventory App</title>

<!-- Supabase + Quagga -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://unpkg.com/quagga"></script>

<style>
/* (unchanged UI styles from your original file) */
body {
  margin: 0;
  font-family: sans-serif;
  background: white;
  color: #111;
  display: flex;
  flex-direction: column;
  min-height: 100vh;    /* allow the page to grow */
  height: auto;         /* not fixed to viewport */
  overflow-y: auto;     /* allow vertical scrolling */
  -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
}
.header { background: #2563eb; color: white; padding: 10px; display: flex; flex-direction: column; position: relative; }
.search-bar { background: white; border-radius: 6px; padding: 6px 10px; margin-bottom: 0; display: flex; align-items: center; position: relative; }
.search-bar input { border: none; outline: none; flex: 1; font-size: 14px; }
.tabs { display: flex; justify-content: space-around; background: #1e40af; border-radius: 6px; margin-top: 8px; }
.tabs button { flex: 1; background: none; border: none; color: white; padding: 10px; font-size: 14px; transition: background 0.2s; }
.tabs button.active { background: white; color: #2563eb; border-radius: 6px; }
.main { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; }
.main.add-tab { justify-content: center; align-items: flex-start; overflow-y: auto; padding: 10px; }

/* Map container and image (new additions, minimal) */
#mapContainer {
  width:100%;
  height:100%;
  overflow: hidden;
  touch-action: none; /* we handle gestures manually for the map only */
  position: absolute;
  left: 0;
  top: 0;
  display: none; /* toggled by tab */
  z-index: 1;
  background: #fff;
  display: flex;
  justify-content: center;
  align-items: center;
}
/* MINIMAL CHANGE: ensure the image fills the container vertically on load
   keep width auto so aspect ratio is preserved. preserve pointer-events none
   so other UI handles input. */
#map {
  will-change: transform;
  transform-origin: 0 0;
  user-select: none;
  -webkit-user-drag: none;
  max-width: none; /* allow free scaling */
  max-height: none;
  pointer-events: none; /* container handles pointer events for panning */
  /* added: make the image fill the container vertically and stay centered */
  height: 100%;
  width: auto;
  object-fit: contain;
  transform: none !important;
}

/* keep original video element for scanning */
#video { width: 100%; height: 100%; object-fit: cover; display: none; }

/* Item card */
.item-card { background: white; border-radius: 16px 16px 0 0; padding: 16px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); position: relative; bottom: 0; }
.item-card h2 { margin: 0 0 6px; font-size: 16px; }
.item-card p { margin: 4px 0; font-size: 14px; color: #333; }
button.save { margin-top: 8px; padding: 8px 12px; border: none; border-radius: 8px; background: #2563eb; color: white; font-size: 14px; cursor: pointer; }
#addForm { display: flex; flex-direction: column; gap: 8px; max-width: 400px; width: 90%; margin: auto; background: #f9f9f9; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
#addForm input[type="text"], #addForm input[type="file"] { padding: 6px 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; width: 100%; box-sizing: border-box; }
.item-card.hidden { display: none; }

/* Torch button overlay moved to bottom center */
#torchBtn {
  position: absolute;
  left: 50%;
  bottom: 18px;
  transform: translateX(-50%);
  z-index: 60;
  background: rgba(0,0,0,0.45);
  color: white;
  border: none;
  padding: 12px;
  border-radius: 50%;
  font-size: 18px;
  display: none;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
}

/* hide the old detect counter UI completely */
#detectBadge { display: none !important; }

/* List Page */
#listPage { width: 100%; max-width: 600px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; }
/* Prevent selection / copy / long-press callout on mobile for list items */
.list-item { background: #fff; border-radius: 8px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); cursor: pointer; display: flex; align-items: center; gap: 12px; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; position: relative; overflow: hidden; }
.list-item h3 { margin: 0 0 6px; font-size: 16px; }
.list-item p { margin: 2px 0; font-size: 13px; color: #444; }
.list-thumb { width: 56px; height: 56px; object-fit: cover; border-radius: 8px; background: #f0f0f0; flex: 0 0 56px; }
.load-more { padding: 10px; border-radius: 8px; border: none; background: #1e40af; color: #fff; cursor: pointer; }
.empty { text-align: center; color: #666; padding: 20px; }

/* overlay used for press progress indicator (NEW) */
.press-overlay {
  position: absolute;
  left: 0; top: 0; right: 0; bottom: 0;
  pointer-events: none;
  background: rgba(255, 0, 0, 0.40); /* blue-ish */
  opacity: 0;
  transition: opacity 120ms linear;
  border-radius: 8px;
}

/* item-card photo preview */
#itemPhotoDisplay { width: 72px; height: 72px; object-fit: cover; border-radius: 10px; float: right; margin-left: 10px; }
#photoPreview { width: 72px; height: 72px; object-fit: cover; border-radius: 8px; background: #eee; display: block; }

/* Modal for enlarged photo */
#photoModal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0; top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.8);
  justify-content: center;
  align-items: center;
}
#photoModal img {
  max-width: 90%;
  max-height: 90%;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  cursor: zoom-out;
}
</style>


<script>
  // ─── Config ─────────────────────────────────────────────────────
  const SUPABASE_URL = 'https://lpcygniycyffeswzrnms.supabase.co/';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxwY3lnbml5Y3lmZmVzd3pybm1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODA5NDIsImV4cCI6MjA3MjY1Njk0Mn0.4bVTsLEwvjyPllLU1-U2vcw3yHkzqj69TZOfuJvSvDQ';
  const SUPABASE_BUCKET = 'item_images';
  
  const { createClient } = Supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
// ─── DOM Elements ───────────────────────────────────────────────
const els = {
  video: document.getElementById('video'),
  mapImg: document.getElementById('map'),
  mapContainer: document.getElementById('mapContainer'),
  main: document.querySelector('.main'),
  itemCard: document.getElementById('itemCard'),
  displays: {
    name: document.getElementById('itemNameDisplay'),
    barcode: document.getElementById('barcodeDisplay'),
    date: document.getElementById('dateDisplay'),
    shelf: document.getElementById('shelfDisplay'),
    category: document.getElementById('categoryDisplay')
  },
  addForm: document.getElementById('addForm'),
  saveBtn: document.getElementById('saveBtn'),
  inputs: {
    name: document.getElementById('itemName'),
    category: document.getElementById('itemCategory'),
    shelf: document.getElementById('itemShelf'),
    section: document.getElementById('itemSection'),
    barcode: document.getElementById('itemBarcode'),
    photo: document.getElementById('itemPhotoInput'),
    photoData: document.getElementById('itemPhotoData')
  },
  listPage: document.getElementById('listPage'),
  searchForm: document.getElementById('searchForm'),
  searchInput: document.getElementById('searchInput'),
  categoryDatalist: document.getElementById('categoryList'),
  torchBtn: document.getElementById('torchBtn'),
  detectBadge: document.getElementById('detectBadge'),
  tabs: document.querySelectorAll('.tabs button'),
  photoPreview: document.getElementById('photoPreview'),
  itemPhotoDisplay: document.getElementById('itemPhotoDisplay'),
  photoModal: document.getElementById('photoModal'),
  modalPhoto: document.getElementById('modalPhoto')
};

// ─── Globals ────────────────────────────────────────────────────
let barcodeDB = {};
let categoriesSet = new Set();
let currentStream = null;
let currentCode = null;
let torchOn = false;
let acceptCooldown = false;
let lastDetectedCode = null;
let consecutiveDetectCount = 0;
const CONFIRMATION_THRESHOLD = 3;
const PAGE_SIZE = 100;

// ─── Utility / Helpers ──────────────────────────────────────────
const hideAllViews = () => {
  ['mapContainer', 'mapImg', 'video', 'addForm', 'listPage']
    .forEach(k => els[k].style.display = 'none');
  els.detectBadge.style.display = els.torchBtn.style.display = 'none';
  els.itemCard.classList.add('hidden');
  els.main.classList.remove('add-tab');
};
const showItemPhoto = src => {
  if (src) {
    els.itemPhotoDisplay.src = src;
    els.itemPhotoDisplay.style.display = 'block';
  } else {
    els.itemPhotoDisplay.style.display = 'none';
  }
};
const showItemDetails = (item, barcode) => {
  const d = els.displays;
  d.name.textContent = item?.name || '-';
  d.barcode.textContent = 'Barcode: ' + (barcode || '-');
  d.date.textContent = 'Date of location: ' + new Date().toLocaleDateString();
  d.shelf.textContent = `Shelf / Section nr: ${item?.shelf || '-'} / ${item?.section || '-'}`;
  d.category.textContent = 'Category: ' + (item?.category || '-');
};
const resetScannerState = () => {
  acceptCooldown = false;
  lastDetectedCode = null;
  consecutiveDetectCount = 0;
  els.detectBadge.textContent = `0/${CONFIRMATION_THRESHOLD}`;
};
const applyMapSizing = () => {
  Object.assign(els.mapImg.style, {
    height: '100%', width: 'auto', objectFit: 'contain',
    transform: 'none', display: 'block'
  });
};
const escapeHtml = s =>
  s ? String(s).replace(/[&<>\"']/g, ch => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[ch])) : '';

function levenshtein(a, b) {
  if (a === b) return 0;
  if (!a.length) return b.length;
  if (!b.length) return a.length;
  const m = Array.from({ length: b.length + 1 }, (_, i) => [i]);
  for (let j = 0; j <= a.length; j++) m[0][j] = j;
  for (let i = 1; i <= b.length; i++)
    for (let j = 1; j <= a.length; j++)
      m[i][j] = b[i - 1] === a[j - 1]
        ? m[i - 1][j - 1]
        : Math.min(m[i - 1][j - 1] + 1, m[i][j - 1] + 1, m[i - 1][j] + 1);
  return m[b.length][a.length];
}

// ─── Tabs ───────────────────────────────────────────────────────
function switchTab(tab) {
  els.tabs.forEach(b => b.classList.remove('active'));
  tab.classList.add('active');
  hideAllViews();

  if (tab.id === 'tab-map') {
    els.mapContainer.style.display = 'flex';
    els.mapImg.style.display = 'block';
    els.itemCard.classList.remove('hidden');
    stopCamera();
  } else if (tab.id === 'tab-scan') {
    els.video.style.display = 'block';
    els.itemCard.classList.add('hidden');
    startCamera();
    els.torchBtn.style.display = 'block';
  } else if (tab.id === 'tab-add') {
    els.listPage.style.display = 'flex';
    els.main.classList.add('add-tab');
    stopCamera();
    renderList(getAllItemsArray(), 0);
  }
}
['tab-map', 'tab-scan', 'tab-add'].forEach(id =>
  document.getElementById(id).addEventListener('click', e => switchTab(e.target))
);

// ─── Category Datalist ──────────────────────────────────────────
function updateCategoryDatalist() {
  els.categoryDatalist.innerHTML = '';
  [...categoriesSet]
    .filter(c => c && c.trim())
    .sort((a, b) => a.localeCompare(b, undefined, { sensitivity: 'base' }))
    .forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      els.categoryDatalist.appendChild(opt);
    });
}

// ─── Data helpers ───────────────────────────────────────────────
const getAllItemsArray = () =>
  Object.entries(barcodeDB).map(([barcode, it]) => ({
    barcode,
    name: it.name || '', category: it.category || '',
    shelf: it.shelf || '', section: it.section || '',
    photo: it.photo || it.photoPath || ''
  }));

// ─── Search ─────────────────────────────────────────────────────
function performSearch() {
  const q = els.searchInput.value.trim().toLowerCase();
  const all = getAllItemsArray();
  if (!q) return renderList(all, 0);

  const results = [];
  for (const it of all) {
    const fields = [it.name, it.barcode, it.category].map(s => (s || '').toLowerCase());
    let [name, barcode, category] = fields;
    let score = 1e4;
    if (name === q) score = -1000;
    else if (barcode === q) score = -900;
    else if (category === q) score = -950;
    else if (name.startsWith(q)) score = -100;
    else if (category.startsWith(q)) score = -120;
    else if (barcode.startsWith(q)) score = -50;
    else if ([name, barcode, category].some(f => f.includes(q))) score = 20;
    else {
      const lv = [name, barcode, category].map(v => levenshtein(q, v));
      if (Math.min(...lv) < 4) score = 50 + Math.min(...lv);
    }
    if (score < 1e4) results.push({ it, score });
  }
  results.sort((a, b) => a.score - b.score);
  renderList(results.map(r => r.it), 0);
}
els.searchForm.addEventListener('submit', e => { e.preventDefault(); switchTab(document.getElementById('tab-add')); performSearch(); });
let debounce; els.searchInput.addEventListener('input', () => {
  switchTab(document.getElementById('tab-add'));
  clearTimeout(debounce);
  debounce = setTimeout(performSearch, 150);
});

// ─── List Rendering ─────────────────────────────────────────────
function renderList(items, start = 0) {
  els.listPage.innerHTML = '';
  const end = Math.min(start + PAGE_SIZE, items.length);
  if (!items.length) return els.listPage.innerHTML = '<div class="empty">No items found.</div>';

  for (let i = start; i < end; i++) {
    const it = items[i];
    const div = document.createElement('div');
    div.className = 'list-item';
    div.dataset.barcode = it.barcode;
    div.innerHTML = `
      ${it.photo ? `<img class="list-thumb" src="${escapeHtml(it.photo)}"/>` :
        `<div class="list-thumb no-img">No<br>Img</div>`}
      <div class="info">
        <h3>${escapeHtml(it.name || '-')}</h3>
        <p>Category: ${escapeHtml(it.category || '-')}</p>
        <p>Barcode: ${escapeHtml(it.barcode)}</p>
        <p>Shelf / Section: ${escapeHtml(it.shelf || '-') } / ${escapeHtml(it.section || '-')}</p>
      </div>
    `;
    div.addEventListener('click', () => {
      const item = barcodeDB[it.barcode];
      if (!item) return alert('Item not found');
      showItemPhoto(item.photo || item.photoPath);
      showItemDetails(item, it.barcode);
      switchTab(document.getElementById('tab-map'));
    });
    els.listPage.appendChild(div);
  }
  if (end < items.length) {
    const btn = document.createElement('button');
    btn.className = 'load-more'; btn.textContent = 'Load more';
    btn.onclick = () => renderList(items, end);
    els.listPage.appendChild(btn);
  }
}

// ─── Supabase Sync ─────────────────────────────────────────────
async function uploadImageToSupabase(barcode, dataURL) {
  const blob = await (await fetch(dataURL)).blob();
  const path = `${barcode}/${Date.now()}.jpg`;
  const { data, error } = await supabaseClient.storage.from(SUPABASE_BUCKET)
    .upload(path, blob, { cacheControl: '3600', upsert: true });
  if (error) throw error;
  return supabaseClient.storage.from(SUPABASE_BUCKET).getPublicUrl(path).data.publicUrl;
}

async function saveItemToSupabase(barcode, item) {
  const { error } = await supabaseClient.from('items').upsert({
    barcode, ...item
  }, { onConflict: 'barcode' });
  if (error) throw error;
}

async function loadDatabaseFromSupabase() {
  const { data, error } = await supabaseClient.from('items').select('*').order('created_at', { ascending: false });
  if (error) throw error;
  barcodeDB = {}; categoriesSet.clear();
  for (const r of data) {
    barcodeDB[r.barcode] = { name: r.name, category: r.category, shelf: r.shelf, section: r.section, photo: r.image_url };
    if (r.category) categoriesSet.add(r.category);
  }
  updateCategoryDatalist();
}

// ─── Camera / Scanner ───────────────────────────────────────────
async function startCamera() {
  resetScannerState();
  try {
    currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    els.video.srcObject = currentStream;
    await els.video.play();
    torchOn = false;
    startScanner();
  } catch (e) { alert('Camera error: ' + e.message); }
}
function stopCamera() {
  resetScannerState();
  [els.detectBadge, els.torchBtn].forEach(el => el.style.display = 'none');
  if (currentStream) currentStream.getTracks().forEach(t => t.stop());
  if (window.Quagga) try { Quagga.stop(); } catch {}
  currentStream = null; els.video.srcObject = null;
}

function startScanner() {
  Quagga.init({
    inputStream: { name: 'Live', type: 'LiveStream', target: els.video },
    decoder: { readers: ['ean_reader', 'upc_reader', 'code_128_reader'] },
    locate: true
  }, err => { if (err) return console.error(err); Quagga.start(); });

  Quagga.onDetected(res => {
    const code = res?.codeResult?.code;
    if (!code || acceptCooldown) return;
    if (lastDetectedCode === code) consecutiveDetectCount++; else { lastDetectedCode = code; consecutiveDetectCount = 1; }
    els.detectBadge.textContent = `${consecutiveDetectCount}/${CONFIRMATION_THRESHOLD}`;
    if (consecutiveDetectCount >= CONFIRMATION_THRESHOLD) {
      acceptCooldown = true; resetScannerState();
      const item = barcodeDB[code];
      if (item) {
        showItemPhoto(item.photo || item.photoPath);
        showItemDetails(item, code);
        switchTab(document.getElementById('tab-map'));
      } else {
        showItemDetails({ name: '❌ Not found', category: '-', shelf: '-', section: '-' }, code);
        els.inputs.barcode.value = code;
        const frame = captureFrameDataURL();
        if (frame) {
          els.inputs.photoData.value = frame;
          els.photoPreview.src = frame;
          els.photoPreview.style.display = 'block';
        }
        els.saveBtn.textContent = '💾 Save Item';
        els.video.style.display = 'none';
        els.addForm.style.display = 'flex';
        els.itemCard.classList.remove('hidden');
        stopCamera();
      }
      setTimeout(() => acceptCooldown = false, 700);
    }
  });
}

function captureFrameDataURL() {
  const c = document.createElement('canvas');
  c.width = els.video.videoWidth || 640;
  c.height = els.video.videoHeight || 480;
  c.getContext('2d').drawImage(els.video, 0, 0, c.width, c.height);
  return c.toDataURL('image/png');
}

// ─── Save Logic ─────────────────────────────────────────────────
els.saveBtn.addEventListener('click', async () => {
  const { name, category, shelf, section, barcode, photoData } = Object.fromEntries(
    Object.entries(els.inputs).map(([k, el]) => [k, el.value.trim()])
  );
  if (!name || !shelf || !section || !barcode || !category)
    return alert('Please fill all fields.');

  let photoUrl = null;
  if (photoData) {
    try { photoUrl = await uploadImageToSupabase(barcode, photoData); }
    catch (err) { return alert('Image upload failed: ' + err.message); }
  } else if (barcodeDB[barcode]?.photo) photoUrl = barcodeDB[barcode].photo;

  await saveItemToSupabase(barcode, { name, category, shelf, section, image_url: photoUrl });
  categoriesSet.add(category); updateCategoryDatalist();
  await loadDatabaseFromSupabase();

  showItemPhoto(photoUrl);
  showItemDetails(barcodeDB[barcode], barcode);
  els.addForm.style.display = 'none';
  switchTab(document.getElementById('tab-map'));
  alert('Item saved.');
});

// ─── Misc Setup ─────────────────────────────────────────────────
window.addEventListener('load', async () => {
  await loadDatabaseFromSupabase().catch(console.warn);
  applyMapSizing();
});
els.mapImg.addEventListener('load', applyMapSizing);
els.itemPhotoDisplay.addEventListener('click', () => {
  els.modalPhoto.src = els.itemPhotoDisplay.src;
  els.photoModal.style.display = 'flex';
});
els.photoModal.addEventListener('click', () => {
  els.photoModal.style.display = 'none'; els.modalPhoto.src = '';
});
els.torchBtn.addEventListener('click', async () => {
  if (!currentStream) return alert('Camera not started');
  const track = currentStream.getVideoTracks()[0];
  try {
    await track.applyConstraints({ advanced: [{ torch: !torchOn }] });
    torchOn = !torchOn;
    els.torchBtn.style.background = torchOn ? '#fff' : 'rgba(0,0,0,0.45)';
    els.torchBtn.style.color = torchOn ? '#111' : '#fff';
  } catch { alert('Torch not supported'); }
});
<script>
