<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Store Item Locator</title>
<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: white; /* ‚úÖ Main background white */
  color: #111;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

/* üîµ Top Navigation */
.header {
  background: #2563eb;
  color: white;
  padding: 10px;
  display: flex;
  flex-direction: column;
}
.search-bar {
  background: white;
  border-radius: 6px;
  padding: 6px 10px;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
}
.search-bar input {
  border: none;
  outline: none;
  flex: 1;
  font-size: 14px;
}
.tabs {
  display: flex;
  justify-content: space-around;
  background: #1e40af;
  border-radius: 6px;
}
.tabs button {
  flex: 1;
  background: none;
  border: none;
  color: white;
  padding: 10px;
  font-size: 14px;
  transition: background 0.2s;
}
.tabs button.active {
  background: white;
  color: #2563eb;
  border-radius: 6px;
}

/* üó∫Ô∏è Main Content (Map / Camera) */
.main {
  flex: 1;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  overflow: hidden;
}
#map {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none; /* default hidden, only show in Map tab */
}
#video {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: none; /* hidden until "Scan" tab */
}

/* üìã Bottom Info Card */
.item-card {
  background: white;
  border-radius: 16px 16px 0 0;
  padding: 16px;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
  position: relative;
  bottom: 0;
}
.item-card h2 {
  margin: 0 0 6px;
  font-size: 16px;
}
.item-card p {
  margin: 4px 0;
  font-size: 14px;
  color: #333;
}
button.save {
  margin-top: 8px;
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  background: #2563eb;
  color: white;
  font-size: 14px;
  cursor: pointer;
}

/* ‚úÖ Add & Renew form tweaks */
#addForm {
  display: flex;
  flex-direction: column; /* stack inputs vertically */
  gap: 8px;
}
#addForm input {
  padding: 6px 10px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 6px;
  width: 100%;
  box-sizing: border-box;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
  <!-- üîµ Header -->
  <div class="header">
    <div class="search-bar">
      <input type="text" placeholder="Search for an item or scan a barcode">
    </div>
    <div class="tabs">
      <button id="tab-add">Add & renew Items</button>
      <button id="tab-map" class="active">Map</button>
      <button id="tab-scan">Scan</button>
    </div>
  </div>

  <!-- üó∫Ô∏è Map / Camera -->
  <div class="main">
    <img id="map" />
    <video id="video" playsinline autoplay muted></video>
  </div>

  <!-- üìã Item Card -->
  <div class="item-card" id="itemCard">
    <h2 id="itemNameDisplay">No item selected</h2>
    <p id="barcodeDisplay">Barcode: -</p>
    <p id="dateDisplay">Date of location: -</p>
    <p id="shelfDisplay">Shelf / Section nr: -</p>
    <button class="save" id="addBtn" style="display:none;">‚ûï Add Item</button>
    <div id="addForm" style="display:none; margin-top:10px;">
      <input type="text" id="itemName" placeholder="Item name" />
      <input type="text" id="itemShelf" placeholder="Shelf number" />
      <input type="text" id="itemSection" placeholder="Section number" />
      <button class="save" id="saveBtn">üíæ Save Item</button>
    </div>
  </div>

<script>
// DOM Elements
const video = document.getElementById('video');
const mapImg = document.getElementById('map');
const itemNameDisplay = document.getElementById('itemNameDisplay');
const barcodeDisplay = document.getElementById('barcodeDisplay');
const dateDisplay = document.getElementById('dateDisplay');
const shelfDisplay = document.getElementById('shelfDisplay');
const addBtn = document.getElementById('addBtn');
const addForm = document.getElementById('addForm');
const saveBtn = document.getElementById('saveBtn');
const itemNameInput = document.getElementById('itemName');
const itemShelfInput = document.getElementById('itemShelf');
const itemSectionInput = document.getElementById('itemSection');

const tabs = document.querySelectorAll(".tabs button");
function setActiveTab(tabId) {
  tabs.forEach(btn => btn.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
}

// Tabs
document.getElementById('tab-map').addEventListener('click', () => {
  setActiveTab('tab-map');
  mapImg.style.display = "block";
  video.style.display = "none";
  addForm.style.display = "none"; // hide add form
  stopCamera();
});
document.getElementById('tab-scan').addEventListener('click', () => {
  setActiveTab('tab-scan');
  mapImg.style.display = "none";
  video.style.display = "block";
  addForm.style.display = "none"; // hide add form
  startCamera();
});
document.getElementById('tab-add').addEventListener('click', () => {
  setActiveTab('tab-add');
  mapImg.style.display = "none"; // hide map for add tab
  video.style.display = "none";
  addForm.style.display = "flex"; // show form
  stopCamera();
});

// DB
let barcodeDB = {};
let currentCode = null;

// CONFIG
const BIN_ID = "68b57c0543b1c97be932f78d"; 
const API_KEY = "$2a$10$rDmMHZ2kVWr8MQlJkpRBb.nYegJ2YjslyO0/4sZEpm7HWbCm0Rjvq";

// Load DB
async function loadDatabase() {
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": API_KEY }
    });
    if (!res.ok) throw new Error("DB not found");
    const data = await res.json();
    barcodeDB = data.record;
  } catch (err) {
    console.warn("‚ö†Ô∏è Using empty DB:", err);
    barcodeDB = {};
  }
}

// Save to DB
async function saveToDatabase(newCode, newItem) {
  barcodeDB[newCode] = newItem;
  await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
    body: JSON.stringify(barcodeDB, null, 2)
  });
}

// Camera Control
function stopCamera() {
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
    video.srcObject = null;
  }
}

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    startScanner();
  } catch (err) {
    alert('Error accessing camera: ' + err.message);
  }
}

function startScanner() {
  Quagga.init({
    inputStream: { name: 'Live', type: 'LiveStream', target: video },
    decoder: { readers: ['ean_reader','upc_reader','code_128_reader'] }
  }, err => {
    if (err) { console.error('Quagga error:', err); return; }
    Quagga.start();
  });

  Quagga.onDetected(result => {
    const code = result.codeResult.code;
    currentCode = code;
    const item = barcodeDB[code];
    if (item) {
      itemNameDisplay.textContent = item.name;
      barcodeDisplay.textContent = "Barcode: " + code;
      dateDisplay.textContent = "Date of location: " + new Date().toLocaleDateString();
      shelfDisplay.textContent = "Shelf / Section nr: " + item.shelf + " / " + item.section;
      addBtn.style.display = "none";
    } else {
      itemNameDisplay.textContent = "‚ùå Not found in database";
      barcodeDisplay.textContent = "Barcode: " + code;
      dateDisplay.textContent = "Date of location: -";
      shelfDisplay.textContent = "Shelf / Section nr: -";
      addBtn.style.display = "block";
    }
    // ‚úÖ Switch back to Map and stop camera
    setActiveTab('tab-map');
    mapImg.style.display = "block";
    video.style.display = "none";
    stopCamera();
  });
}

// Add item
addBtn.addEventListener("click", () => {
  addForm.style.display = "flex";
});
saveBtn.addEventListener("click", async () => {
  const name = itemNameInput.value.trim();
  const shelf = itemShelfInput.value.trim();
  const section = itemSectionInput.value.trim();
  if (!name || !shelf || !section) {
    alert("Please fill all fields");
    return;
  }
  const newItem = { name, shelf, section };
  await saveToDatabase(currentCode, newItem);
  itemNameDisplay.textContent = name;
  shelfDisplay.textContent = "Shelf / Section nr: " + shelf + " / " + section;
  addForm.style.display = "none";
  addBtn.style.display = "none";
});

// Random Map Images
const mapImages = [
  "https://i.imgur.com/7bYwV7H.png",
  "https://i.imgur.com/1D5Zb0j.png",
  "https://i.imgur.com/Z0YyAvf.png"
];
mapImg.src = mapImages[Math.floor(Math.random() * mapImages.length)];
mapImg.style.display = "block"; // default show map on page load

window.addEventListener('load', async () => {
  await loadDatabase();
});
</script>
</body>
</html>
