<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Store Item Locator</title>
<style>
/* (same CSS as before, suggestions block removed visually since not needed) */
.suggestions { display: none !important; }
</style>
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
  <!-- 🔵 Header -->
  <div class="header">
    <form class="search-bar" id="searchForm" autocomplete="off">
      <input type="text" id="searchInput" placeholder="Search for an item or scan a barcode">
      <ul class="suggestions" id="suggestions"></ul>
    </form>
    <div class="tabs">
      <button id="tab-add">List</button>
      <button id="tab-map" class="active">Map</button>
      <button id="tab-scan">Scan</button>
    </div>
  </div>

  <!-- 🗺️ Map / Camera / List -->
  <div class="main">
    <img id="map" />
    <video id="video" playsinline autoplay muted></video>
    <div id="listPage" style="display:none;"></div>
  </div>

  <!-- 📋 Item Card for Scan -->
  <div class="item-card" id="itemCard">
    <h2 id="itemNameDisplay">No item selected</h2>
    <p id="barcodeDisplay">Barcode: -</p>
    <p id="dateDisplay">Date of location: -</p>
    <p id="shelfDisplay">Shelf / Section nr: -</p>
    <div id="addForm" style="display:none; margin-top:10px;">
      <input type="text" id="itemBarcode" placeholder="Barcode" readonly />
      <input type="text" id="itemName" placeholder="Item name" />
      <input type="text" id="itemShelf" placeholder="Shelf number" />
      <input type="text" id="itemSection" placeholder="Section number" />
      <button class="save" id="saveBtn">💾 Save Item</button>
    </div>
  </div>

<script>
// DOM Elements (same as before)
const video = document.getElementById('video');
const mapImg = document.getElementById('map');
const mainDiv = document.querySelector('.main');
const itemCard = document.getElementById('itemCard');
const itemNameDisplay = document.getElementById('itemNameDisplay');
const barcodeDisplay = document.getElementById('barcodeDisplay');
const dateDisplay = document.getElementById('dateDisplay');
const shelfDisplay = document.getElementById('shelfDisplay');
const addForm = document.getElementById('addForm');
const saveBtn = document.getElementById('saveBtn');
const itemNameInput = document.getElementById('itemName');
const itemShelfInput = document.getElementById('itemShelf');
const itemSectionInput = document.getElementById('itemSection');
const itemBarcodeInput = document.getElementById('itemBarcode');
const listPage = document.getElementById('listPage');
const searchInput = document.getElementById('searchInput');

const tabs = document.querySelectorAll(".tabs button");
function switchTab(tab) {
  tabs.forEach(btn => btn.classList.remove("active"));
  tab.classList.add("active");

  mapImg.style.display = "none";
  video.style.display = "none";
  addForm.style.display = "none";
  listPage.style.display = "none";
  itemCard.classList.add("hidden");
  mainDiv.classList.remove("add-tab");

  if(tab.id === "tab-map"){
    mapImg.style.display = "block";
    itemCard.classList.remove("hidden");
    stopCamera();
  } else if(tab.id === "tab-scan"){
    video.style.display = "block";
    itemCard.classList.add("hidden");
    startCamera();
  } else if(tab.id === "tab-add"){
    listPage.style.display = "flex";
    mainDiv.classList.add("add-tab");
    renderList();
    stopCamera();
  }
}

document.getElementById('tab-map').addEventListener('click', e => switchTab(e.target));
document.getElementById('tab-scan').addEventListener('click', e => switchTab(e.target));
document.getElementById('tab-add').addEventListener('click', e => switchTab(e.target));

// DB
let barcodeDB = {};
let currentCode = null;

// CONFIG
const BIN_ID = "68b57c0543b1c97be932f78d"; 
const API_KEY = "$2a$10$rDmMHZ2kVWr8MQlJkpRBb.nYegJ2YjslyO0/4sZEpm7HWbCm0Rjvq";

async function loadDatabase() {
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": API_KEY }
    });
    if (!res.ok) throw new Error("DB not found");
    const data = await res.json();
    barcodeDB = data.record;
  } catch (err) {
    console.warn("⚠️ Using empty DB:", err);
    barcodeDB = {};
  }
}

async function saveToDatabase(newCode, newItem) {
  barcodeDB[newCode] = newItem;
  await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
    body: JSON.stringify(barcodeDB, null, 2)
  });
}

function stopCamera() {
  if (video.srcObject) video.srcObject.getTracks().forEach(track => track.stop());
  video.srcObject = null;
  if (Quagga) Quagga.stop();
}

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    startScanner();
  } catch (err) {
    alert('Error accessing camera: ' + err.message);
  }
}

// Barcode scanner with confirmation delay
let lastDetected = null;
let detectStartTime = null;

function startScanner() {
  Quagga.init({
    inputStream: { name: 'Live', type: 'LiveStream', target: video },
    decoder: { readers: ['ean_reader','upc_reader','code_128_reader'] }
  }, err => { if(err) console.error(err); else Quagga.start(); });

  Quagga.onDetected(result => {
    const code = result.codeResult.code;

    if (lastDetected !== code) {
      lastDetected = code;
      detectStartTime = Date.now();
      return;
    }

    if (Date.now() - detectStartTime < 2000) {
      return; // wait until stable for 2s
    }

    // Confirmed barcode
    currentCode = code;
    const item = barcodeDB[code];
    if(item){
      itemNameDisplay.textContent = item.name;
      barcodeDisplay.textContent = "Barcode: " + code;
      dateDisplay.textContent = "Date of location: " + new Date().toLocaleDateString();
      shelfDisplay.textContent = "Shelf / Section nr: " + item.shelf + " / " + item.section;
      switchTab(document.getElementById('tab-map'));
    } else {
      itemNameDisplay.textContent = "❌ Not found in database";
      barcodeDisplay.textContent = "Barcode: " + code;
      dateDisplay.textContent = "Date of location: -";
      shelfDisplay.textContent = "";
      itemBarcodeInput.value = code;
      video.style.display = "none";
      addForm.style.display = "flex";
      itemCard.classList.remove("hidden");
      stopCamera();
    }
  });
}

// Save new item
saveBtn.addEventListener("click", async () => {
  const name = itemNameInput.value.trim();
  const shelf = itemShelfInput.value.trim();
  const section = itemSectionInput.value.trim();
  const barcode = itemBarcodeInput.value.trim();
  if(!name || !shelf || !section || !barcode){
    alert("Please fill all fields");
    return;
  }
  const newItem = { name, shelf, section };
  await saveToDatabase(barcode,newItem);
  itemNameDisplay.textContent = name;
  shelfDisplay.textContent = "Shelf / Section nr: " + shelf + " / " + section;
  addForm.style.display = "none";
});

// Render list with optional sorting
function renderList(query = "") {
  listPage.innerHTML = "";
  let items = Object.entries(barcodeDB);

  if (query) {
    items.sort((a, b) => {
      const aName = a[1].name.toLowerCase();
      const bName = b[1].name.toLowerCase();
      const q = query.toLowerCase();
      return aName.indexOf(q) - bName.indexOf(q);
    });
  }

  for (const [code, item] of items) {
    const div = document.createElement("div");
    div.className = "list-item";
    div.innerHTML = `
      <h3>${item.name}</h3>
      <p>Barcode: ${code}</p>
      <p>Shelf: ${item.shelf}</p>
      <p>Section: ${item.section}</p>
    `;
    listPage.appendChild(div);
  }
}

// ✅ Search input → go to List page and sort
searchInput.addEventListener("input", () => {
  const query = searchInput.value.trim();
  switchTab(document.getElementById("tab-add"));
  renderList(query);
});

// Init
mapImg.style.display = "block";
window.addEventListener('load', async () => { await loadDatabase(); });
</script>
</body>
</html>
