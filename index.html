<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Camera Preview with Barcode Scanning</title>
<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  display: flex;
  justify-content: center;
  align-items: start;
  padding: 16px;
}
.card {
  background: #111827;
  border-radius: 16px;
  padding: 16px;
  max-width: 640px;
  width: 100%;
  box-shadow: 0 10px 25px rgba(0,0,0,.3);
}
h1 { font-size: 1.25rem; margin: 0 0 8px; }
p { color: #9ca3af; margin: 8px 0 16px; }
video { width: 100%; border-radius: 12px; background: #000; }
#numbers {
  margin-top: 10px;
  font-size: 18px;
  color: #22c55e;
  white-space: pre-line;
  word-break: break-all;
}
button {
  margin-top: 10px;
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  background: #2563eb;
  color: white;
  font-size: 14px;
  cursor: pointer;
}
button:hover {
  background: #1e40af;
}
#addForm {
  margin-top: 12px;
  display: none;
  flex-direction: column;
  gap: 6px;
}
#addForm input {
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #374151;
  background: #1f2937;
  color: white;
}
.footer { color: #9ca3af; font-size: 12px; text-align: center; margin-top: 10px; }
</style>

<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
</head>
<body>
<div class="card">
  <h1>ðŸ“· Scan a barcode</h1>
  <p>The camera feed will start automatically. Barcode numbers will appear below when detected.</p>
  <video id="video" playsinline autoplay muted></video>
  <div id="numbers">Detected barcodes will appear here...</div>
  <button id="addBtn" style="display:none;">âž• Add Item</button>

  <!-- Add new product form -->
  <div id="addForm">
    <input type="text" id="itemName" placeholder="Item name" />
    <input type="number" step="0.01" id="itemPrice" placeholder="Price" />
    <button id="saveBtn">ðŸ’¾ Save Item</button>
  </div>

  <div class="footer">Your camera feed runs in the browser. Works best over HTTPS.</div>
</div>

<script>
const video = document.getElementById('video');
const numbersDiv = document.getElementById('numbers');
const addBtn = document.getElementById('addBtn');
const addForm = document.getElementById('addForm');
const saveBtn = document.getElementById('saveBtn');
const itemNameInput = document.getElementById('itemName');
const itemPriceInput = document.getElementById('itemPrice');

// For smoothing barcode readings
let detectedCodes = {};
const stableThreshold = 3; 
const displayDuration = 2000; 
let lastDisplayTime = 0;

let barcodeDB = {};
let currentCode = null;

// ==========================
// ðŸ”§ CONFIG (JSONBin)
// ==========================
const BIN_ID = "68b57c0543b1c97be932f78d"; 
const API_KEY = "$2a$10$rDmMHZ2kVWr8MQlJkpRBb.nYegJ2YjslyO0/4sZEpm7HWbCm0Rjvq";

// Load DB from JSONBin
async function loadDatabase() {
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
      headers: { "X-Master-Key": API_KEY }
    });
    if (!res.ok) throw new Error("barcodes.json not found, using empty DB");
    const data = await res.json();
    barcodeDB = data.record;
    console.log("âœ… Database loaded", barcodeDB);
  } catch (err) {
    console.warn("âš ï¸ Could not load database, starting empty:", err);
    barcodeDB = {};
  }
}

// Save new barcode entry to JSONBin
async function saveToDatabase(newCode, newItem) {
  try {
    // update local copy
    barcodeDB[newCode] = newItem;

    // PUT full DB to JSONBin
    const updateRes = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        "X-Master-Key": API_KEY
      },
      body: JSON.stringify(barcodeDB, null, 2)
    });

    if (updateRes.ok) {
      alert("âœ… Saved to JSONBin!");
    } else {
      const errText = await updateRes.text();
      console.error("JSONBin error:", errText);
      alert("âŒ Failed to save to JSONBin. Check console.");
    }
  } catch (err) {
    console.error("Error saving to JSONBin:", err);
    alert("âŒ Error saving to JSONBin.");
  }
}

// Start camera
async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
    video.srcObject = stream;
    startScanner();
  } catch (err) {
    alert('Error accessing camera: ' + err.message);
  }
}

// Quagga init
function startScanner() {
  Quagga.init({
    inputStream: {
      name: 'Live',
      type: 'LiveStream',
      target: video,
      constraints: { width: 640, height: 480, facingMode: 'environment' }
    },
    locator: { patchSize: 'medium', halfSample: true },
    decoder: { readers: ['code_128_reader','ean_reader','ean_8_reader','code_39_reader','code_39_vin_reader','codabar_reader','upc_reader','upc_e_reader','i2of5_reader'] },
    locate: true,
    numOfWorkers: 0
  }, err => {
    if (err) { console.error('Error initializing Quagga:', err); return; }
    Quagga.start();
  });

  Quagga.onDetected(result => {
    const code = result.codeResult.code;
    const now = Date.now();

    detectedCodes[code] = (detectedCodes[code] || 0) + 1;
    for (let c in detectedCodes) {
      if (c !== code && now - lastDisplayTime > displayDuration) delete detectedCodes[c];
    }

    if (detectedCodes[code] >= stableThreshold) {
      currentCode = code;
      let message = `Detected Barcode: ${code}`;
      if (barcodeDB[code]) {
        const item = barcodeDB[code];
        message += `\nItem: ${item.name}\nPrice: $${item.price}`;
        addBtn.style.display = "none";
        addForm.style.display = "none";
      } else {
        message += "\nâŒ Not found in database.";
        addBtn.style.display = "block"; 
      }
      numbersDiv.textContent = message;
      lastDisplayTime = now;
      detectedCodes = {};
    }
  });
}

// Add item flow
addBtn.addEventListener("click", () => {
  addForm.style.display = "flex";
  itemNameInput.value = "";
  itemPriceInput.value = "";
});

saveBtn.addEventListener("click", async () => {
  const name = itemNameInput.value.trim();
  const price = parseFloat(itemPriceInput.value);
  if (!name || isNaN(price)) {
    alert("Please enter valid name and price.");
    return;
  }

  const newItem = { name, price };
  await saveToDatabase(currentCode, newItem);

  // update in-memory DB immediately
  barcodeDB[currentCode] = newItem;
  numbersDiv.textContent = `âœ… Added to DB!\nDetected Barcode: ${currentCode}\nItem: ${name}\nPrice: $${price}`;

  addForm.style.display = "none";
  addBtn.style.display = "none";
});

// Stop camera when tab hidden
document.addEventListener('visibilitychange', () => {
  if (document.hidden && video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
  }
});

window.addEventListener('load', async () => {
  await loadDatabase();
  startCamera();
});
</script>
</body>
</html>
