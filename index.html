<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Store Item Locator</title>
<style>
html,body{height:100%;margin:0;font-family:sans-serif;background:#fff;color:#111;display:flex;flex-direction:column}
.header{background:#2563eb;color:#fff;padding:10px;display:flex;flex-direction:column;position:relative}
.search-bar{background:#fff;border-radius:6px;padding:6px 10px;display:flex;align-items:center}
.search-bar input{border:0;outline:0;flex:1;font-size:14px}
.tabs{display:flex;justify-content:space-around;background:#1e40af;border-radius:6px;margin-top:8px}
.tabs button{flex:1;background:none;border:0;color:#fff;padding:10px;font-size:14px}
.tabs button.active{background:#fff;color:#2563eb;border-radius:6px}
.main{flex:1;display:flex;justify-content:center;align-items:center;position:relative;overflow:hidden}
.main.add-tab{justify-content:center;align-items:flex-start;overflow-y:auto;padding:10px}
#mapContainer{width:100%;height:100%;overflow:hidden;touch-action:none;position:absolute;left:0;top:0;display:none;z-index:1;background:#fff;display:flex;justify-content:center;align-items:center}
#map{will-change:transform;transform-origin:0 0;user-select:none;-webkit-user-drag:none;max-width:none;max-height:none;pointer-events:none;height:100%;width:auto;object-fit:contain}
#video{width:100%;height:100%;object-fit:cover;display:none}
#video.fullscreen{position:fixed;inset:0;width:100vw;height:100vh;z-index:1;object-fit:cover}
.item-card{background:#fff;border-radius:16px 16px 0 0;padding:16px;box-shadow:0 -2px 10px rgba(0,0,0,.2);position:relative;bottom:0}
.item-card h2{margin:0 0 6px;font-size:16px}
.item-card p{margin:4px 0;font-size:14px;color:#333}
button.save{margin-top:8px;padding:8px 12px;border:0;border-radius:8px;background:#2563eb;color:#fff;font-size:14px;cursor:pointer}
#addForm{display:flex;flex-direction:column;gap:8px;max-width:400px;width:90%;margin:auto;background:#f9f9f9;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.2)}
#addForm input[type="text"],#addForm input[type="file"]{padding:6px 10px;font-size:14px;border:1px solid #ccc;border-radius:6px;width:100%;box-sizing:border-box}
.item-card.hidden{display:none}
#torchBtn{position:absolute;left:50%;bottom:18px;transform:translateX(-50%);z-index:60;background:rgba(0,0,0,.45);color:#fff;border:0;padding:12px;border-radius:50%;font-size:18px;display:none;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.3)}
#detectBadge{display:none!important}
#listPage{width:100%;max-width:600px;margin:0 auto;display:flex;flex-direction:column;gap:10px}
.list-item{background:#fff;border-radius:8px;padding:10px;box-shadow:0 2px 6px rgba(0,0,0,.08);cursor:pointer;display:flex;align-items:center;gap:12px;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;position:relative;overflow:hidden}
.list-item h3{margin:0 0 6px;font-size:16px}
.list-item p{margin:2px 0;font-size:13px;color:#444}
.list-thumb{width:56px;height:56px;object-fit:cover;border-radius:8px;background:#f0f0f0;flex:0 0 56px}
.load-more{padding:10px;border-radius:8px;border:0;background:#1e40af;color:#fff;cursor:pointer}
.empty{text-align:center;color:#666;padding:20px}
.press-overlay{position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:none;background:rgba(255,0,0,.4);opacity:0;transition:opacity 120ms linear;border-radius:8px}
#itemPhotoDisplay{width:72px;height:72px;object-fit:cover;border-radius:10px;float:right;margin-left:10px}
#photoPreview{width:72px;height:72px;object-fit:cover;border-radius:8px;background:#eee;display:block}
#photoModal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.8);justify-content:center;align-items:center}
#photoModal img{max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.5);cursor:zoom-out}
</style>
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
</head>
<body>
<div class="header">
  <form class="search-bar" id="searchForm" autocomplete="off"><input type="text" id="searchInput" placeholder="Search for an item or scan a barcode"></form>
  <div class="tabs"><button id="tab-add">List</button><button id="tab-map" class="active">Map</button><button id="tab-scan">Scan</button></div>
</div>

<div class="main">
  <div id="mapContainer"><img id="map" src="https://lpcygniycyffeswzrnms.supabase.co/storage/v1/object/public/Map/map_random%20(1).png" alt="Store map"></div>
  <video id="video" playsinline autoplay muted></video>
  <div id="listPage" style="display:none"></div>
  <button id="torchBtn" title="Toggle flash">ðŸ”¦</button>
  <div id="detectBadge">0/3</div>
</div>

<div class="item-card" id="itemCard">
  <img id="itemPhotoDisplay" src="" alt="photo" style="display:none">
  <h2 id="itemNameDisplay">No item selected</h2>
  <p id="barcodeDisplay">Barcode: -</p>
  <p id="dateDisplay">Date of location: -</p>
  <p id="shelfDisplay">Shelf / Section nr: -</p>
  <p id="categoryDisplay">Category: -</p>
  <div id="addForm" style="display:none;margin-top:10px">
    <input type="text" id="itemBarcode" placeholder="Barcode" readonly>
    <input type="text" id="itemName" placeholder="Item name">
    <input list="categoryList" id="itemCategory" placeholder="Category (start typing, e.g. soda)"><datalist id="categoryList"></datalist>
    <input type="text" id="itemShelf" placeholder="Shelf number">
    <input type="text" id="itemSection" placeholder="Section number">
    <div style="display:flex;gap:10px;align-items:center">
      <img id="photoPreview" src="" alt="preview" style="display:none">
      <div style="flex:1">
        <input type="file" id="itemPhotoInput" accept="image/*"><small style="color:#666">You can replace the captured photo before saving.</small>
        <input type="hidden" id="itemPhotoData">
      </div>
    </div>
    <button class="save" id="saveBtn">ðŸ’¾ Save Item</button>
  </div>
</div>

<div id="photoModal"><img src="" alt="Enlarged photo" id="modalPhoto"></div>

<script>
const SUPABASE_URL='https://lpcygniycyffeswzrnms.supabase.co/',SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxwY3lnbml5Y3lmZmVzd3pybm1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODA5NDIsImV4cCI6MjA3MjY1Njk0Mn0.4bVTsLEwvjyPllLU1-U2vcw3yHkzqj69TZOfuJvSvDQ',SUPABASE_BUCKET='item_images';
const { createClient } = supabase; const supabaseClient = createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const video=document.getElementById('video'),mapImg=document.getElementById('map'),mapContainer=document.getElementById('mapContainer'),mainDiv=document.querySelector('.main'),itemCard=document.getElementById('itemCard'),itemNameDisplay=document.getElementById('itemNameDisplay'),barcodeDisplay=document.getElementById('barcodeDisplay'),dateDisplay=document.getElementById('dateDisplay'),shelfDisplay=document.getElementById('shelfDisplay'),categoryDisplay=document.getElementById('categoryDisplay'),addForm=document.getElementById('addForm'),saveBtn=document.getElementById('saveBtn'),itemNameInput=document.getElementById('itemName'),itemCategoryInput=document.getElementById('itemCategory'),itemShelfInput=document.getElementById('itemShelf'),itemSectionInput=document.getElementById('itemSection'),itemBarcodeInput=document.getElementById('itemBarcode'),listPage=document.getElementById('listPage'),searchForm=document.getElementById('searchForm'),searchInput=document.getElementById('searchInput'),categoryDatalist=document.getElementById('categoryList'),torchBtn=document.getElementById('torchBtn'),detectBadge=document.getElementById('detectBadge'),tabs=document.querySelectorAll('.tabs button'),photoPreview=document.getElementById('photoPreview'),itemPhotoInput=document.getElementById('itemPhotoInput'),itemPhotoData=document.getElementById('itemPhotoData'),itemPhotoDisplay=document.getElementById('itemPhotoDisplay');

let barcodeDB={},currentCode=null,categoriesSet=new Set(),currentStream=null,torchOn=false,CONFIRMATION_THRESHOLD=3,lastDetectedCode=null,consecutiveDetectCount=0,acceptCooldown=false,PAGE_SIZE=100,lastRenderStart=0,lastRenderedItems=[];

function switchTab(tab){
  tabs.forEach(btn=>btn.classList.remove('active'));tab.classList.add('active');
  mapContainer.style.display='none';mapImg.style.display='none';video.style.display='none';addForm.style.display='none';listPage.style.display='none';itemCard.classList.add('hidden');mainDiv.classList.remove('add-tab');detectBadge.style.display='none';torchBtn.style.display='none';
  video.classList.remove('fullscreen');
  if(tab.id==='tab-map'){mapContainer.style.display='flex';mapImg.style.display='block';itemCard.classList.remove('hidden');stopCamera()}
  else if(tab.id==='tab-scan'){video.style.display='block';video.classList.add('fullscreen');itemCard.classList.add('hidden');startCamera();torchBtn.style.display='block'}
  else if(tab.id==='tab-add'){listPage.style.display='flex';mainDiv.classList.add('add-tab');stopCamera();const all=getAllItemsArray();lastRenderStart=0;renderList(all,0)}
}
document.getElementById('tab-map').addEventListener('click',e=>switchTab(e.target));
document.getElementById('tab-scan').addEventListener('click',e=>switchTab(e.target));
document.getElementById('tab-add').addEventListener('click',e=>switchTab(e.target));

function getAllItemsArray(){return Object.entries(barcodeDB).map(([barcode,item])=>({barcode,name:item.name||'',category:item.category||'',shelf:item.shelf||'',section:item.section||'',photo:item.photo||item.photoPath||''}))}

function levenshtein(a,b){if(a===b)return 0;if(!a.length)return b.length;if(!b.length)return a.length;const m=[];for(let i=0;i<=b.length;i++)m[i]=[i];for(let j=0;j<=a.length;j++)m[0][j]=j;for(let i=1;i<=b.length;i++)for(let j=1;j<=a.length;j++)m[i][j]=b.charAt(i-1)===a.charAt(j-1)?m[i-1][j-1]:Math.min(m[i-1][j-1]+1,m[i][j-1]+1,m[i-1][j]+1);return m[b.length][a.length]}

function updateCategoryDatalist(){categoryDatalist.innerHTML='';const arr=Array.from(categoriesSet).filter(c=>c&&String(c).trim()!=='');arr.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base'}));for(const c of arr){const o=document.createElement('option');o.value=c;categoryDatalist.appendChild(o)}}

function openItemForEdit(barcode){
  const item=barcodeDB[barcode];
  tabs.forEach(btn=>btn.classList.remove('active'));document.getElementById('tab-scan').classList.add('active');
  mapContainer.style.display='none';mapImg.style.display='none';video.style.display='none';listPage.style.display='none';detectBadge.style.display='none';torchBtn.style.display='none';
  itemCard.classList.remove('hidden');addForm.style.display='flex';
  itemBarcodeInput.value=barcode||'';itemNameInput.value=(item&&item.name)?item.name:'';itemCategoryInput.value=(item&&item.category)?item.category:'';itemShelfInput.value=(item&&item.shelf)?item.shelf:'';itemSectionInput.value=(item&&item.section)?item.section:'';
  itemNameDisplay.textContent=(item&&item.name)?item.name:'-';barcodeDisplay.textContent='Barcode: '+(barcode||'-');dateDisplay.textContent='Date of location: '+new Date().toLocaleDateString();shelfDisplay.textContent='Shelf / Section nr: '+((item&&item.shelf)|| '-')+' / '+((item&&item.section)||'-');categoryDisplay.textContent='Category: '+((item&&item.category)||'-');
  if(item&&(item.photo||item.photoPath)){const src=item.photo||item.photoPath;itemPhotoDisplay.src=src;itemPhotoDisplay.style.display='block';photoPreview.src=src;photoPreview.style.display='block';itemPhotoData.value=''}else{itemPhotoDisplay.style.display='none';photoPreview.style.display='none';itemPhotoData.value='';photoPreview.src='';itemPhotoDisplay.src=''}
  saveBtn.textContent='ðŸ’¾ Save changes';
}

function renderList(items,startIndex=0){
  lastRenderedItems=items;lastRenderStart=startIndex;listPage.innerHTML='';const end=Math.min(startIndex+PAGE_SIZE,items.length);
  if(items.length===0){const e=document.createElement('div');e.className='empty';e.textContent='No items found.';listPage.appendChild(e);return}
  for(let i=startIndex;i<end;i++){const it=items[i];const div=document.createElement('div');div.className='list-item';div.setAttribute('data-barcode',it.barcode);const thumbSrc=it.photo?escapeHtml(it.photo):'';const thumbHTML=thumbSrc?`<img class="list-thumb" src="${thumbSrc}" alt="thumb">`:`<div class="list-thumb" style="display:flex;align-items:center;justify-content:center;color:#888;font-size:12px">No<br>Img</div>`;div.innerHTML=`${thumbHTML}<div style="flex:1;"><h3>${escapeHtml(it.name||'-')}</h3><p>Category: ${escapeHtml(it.category||'-')}</p><p>Barcode: ${escapeHtml(it.barcode)}</p><p>Shelf / Section: ${escapeHtml(it.shelf||'-')} / ${escapeHtml(it.section||'-')}</p></div>`;const overlay=document.createElement('div');overlay.className='press-overlay';div.appendChild(overlay);
    div.addEventListener('click',()=>{const barcode=div.dataset.barcode;const item=barcodeDB[barcode];if(item){if(item.photo){itemPhotoDisplay.src=item.photo;itemPhotoDisplay.style.display='block'}else if(item.photoPath){itemPhotoDisplay.src=item.photoPath;itemPhotoDisplay.style.display='block'}else itemPhotoDisplay.style.display='none';itemNameDisplay.textContent=item.name||'-';barcodeDisplay.textContent='Barcode: '+barcode;dateDisplay.textContent='Date of location: '+new Date().toLocaleDateString();shelfDisplay.textContent='Shelf / Section nr: '+(item.shelf||'-')+' / '+(item.section||'-');categoryDisplay.textContent='Category: '+(item.category||'-');switchTab(document.getElementById('tab-map'))}else alert('Item not found')});
    (function(localDiv,barcode,overlayEl){let longPressTimer=null;const LONG_PRESS_MS=1250;let pressingStart=null;let raf=null;function updateOverlayProgress(){if(!pressingStart)return;const elapsed=Date.now()-pressingStart;const clamped=Math.max(0,Math.min(1,elapsed/LONG_PRESS_MS));overlayEl.style.opacity=String(0.12+clamped*0.88);if(clamped>=1)return;raf=requestAnimationFrame(updateOverlayProgress)}function startLongPress(e){clearLongPress();pressingStart=Date.now();overlayEl.style.transition='opacity 60ms linear';raf=requestAnimationFrame(updateOverlayProgress);longPressTimer=setTimeout(()=>{longPressTimer=null;pressingStart=null;cancelAnimationFrame(raf);overlayEl.style.opacity='0';openItemForEdit(barcode)},LONG_PRESS_MS)}function clearLongPress(){if(longPressTimer){clearTimeout(longPressTimer);longPressTimer=null}if(raf){cancelAnimationFrame(raf);raf=null}pressingStart=null;overlayEl.style.transition='opacity 180ms linear';overlayEl.style.opacity='0'}localDiv.addEventListener('mousedown',e=>{if(e.button!==0)return;startLongPress(e)});localDiv.addEventListener('mouseup',clearLongPress);localDiv.addEventListener('mouseleave',clearLongPress);localDiv.addEventListener('touchstart',e=>{if(e.touches&&e.touches.length>1)return;startLongPress(e)},{passive:true});localDiv.addEventListener('touchend',clearLongPress);localDiv.addEventListener('touchcancel',clearLongPress);localDiv.addEventListener('contextmenu',e=>{e.preventDefault()});localDiv.addEventListener('selectstart',e=>{e.preventDefault()});localDiv.addEventListener('pointercancel',clearLongPress);localDiv.addEventListener('pointerup',clearLongPress)})(div,it.barcode,overlay);
    listPage.appendChild(div)}
  if(end<items.length){const btn=document.createElement('button');btn.className='load-more';btn.textContent='Load more';btn.addEventListener('click',()=>{renderList(items,end)});listPage.appendChild(btn)}
}

function escapeHtml(str){if(!str)return'';return String(str).replace(/[&<>\"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]))}

function performSearch(){const qRaw=searchInput.value.trim();const q=qRaw.toLowerCase();const all=getAllItemsArray();if(q===''){renderList(all,0);return}const results=[];for(const it of all){const name=(it.name||'').toLowerCase();const barcode=(it.barcode||'').toLowerCase();const category=(it.category||'').toLowerCase();let score=10000;if(name===q)score=-1000;else if(barcode===q)score=-900;else if(category===q)score=-950;else if(name.startsWith(q))score=-100+name.indexOf(q);else if(category.startsWith(q))score=-120+category.indexOf(q);else if(barcode.startsWith(q))score=-50+barcode.indexOf(q);else if(name.includes(q))score=10+name.indexOf(q);else if(category.includes(q))score=5+category.indexOf(q);else if(barcode.includes(q))score=20+barcode.indexOf(q);else if((it.shelf||'').toLowerCase().includes(q)||(it.section||'').toLowerCase().includes(q))score=200;else{const levName=levenshtein(q,name);const maxAllowed=Math.max(2,Math.floor(name.length*0.25));if(name&&levName<=maxAllowed)score=50+levName;else{const levBarcode=levenshtein(q,barcode);const maxAllowedBar=Math.max(1,Math.floor(barcode.length*0.15));if(barcode&&levBarcode<=maxAllowedBar)score=60+levBarcode;else{const levCategory=levenshtein(q,category);const maxAllowedCat=Math.max(1,Math.floor(category.length*0.25));if(category&&levCategory<=maxAllowedCat)score=70+levCategory}}}if(score<10000)results.push({it,score})}
  if(results.length===0){for(const it of all){const hay=((it.name||'')+' '+(it.barcode||'')+' '+(it.shelf||'')+' '+(it.section||'')+' '+(it.category||'')).toLowerCase();if(hay.includes(q))results.push({it,score:500+hay.indexOf(q)})}}
  results.sort((a,b)=>a.score-b.score);const items=results.map(r=>r.it);renderList(items,0)
}

searchForm.addEventListener('submit',e=>{e.preventDefault();switchTab(document.getElementById('tab-add'));performSearch()});
let debounceTimer=null;searchInput.addEventListener('input',()=>{switchTab(document.getElementById('tab-add'));if(debounceTimer)clearTimeout(debounceTimer);debounceTimer=setTimeout(()=>{performSearch();debounceTimer=null},150)});
searchInput.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();switchTab(document.getElementById('tab-add'));performSearch()}});

function dataURLtoBlob(dataURL){const parts=dataURL.split(',');const meta=parts[0];const base64=parts[1];const mime=meta.match(/:(.*?);/)[1];const binary=atob(base64);const len=binary.length;const u8=new Uint8Array(len);for(let i=0;i<len;i++)u8[i]=binary.charCodeAt(i);return new Blob([u8],{type:mime})}

async function uploadImageToSupabase(barcode,dataURL){if(!dataURL)return null;try{const blob=dataURLtoBlob(dataURL);const filename=`${barcode}/${Date.now()}.jpg`;const {data,error:uploadErr}=await supabaseClient.storage.from(SUPABASE_BUCKET).upload(filename,blob,{cacheControl:'3600',upsert:true});if(uploadErr)throw uploadErr;const {data:publicData}=supabaseClient.storage.from(SUPABASE_BUCKET).getPublicUrl(filename);return publicData.publicUrl}catch(err){console.error('Supabase upload error',err);throw err}}

async function saveItemToSupabase(barcode,item){try{const row={barcode:barcode,name:item.name||null,category:item.category||null,shelf:item.shelf||null,section:item.section||null,image_url:item.image_url||null};const {data,error}=await supabaseClient.from('items').upsert(row,{onConflict:'barcode'});if(error)throw error;return data}catch(err){console.error('saveItemToSupabase error',err);throw err}}

async function loadDatabaseFromSupabase(){try{const {data,error}=await supabaseClient.from('items').select('*').order('created_at',{ascending:false});if(error)throw error;barcodeDB={};categoriesSet=new Set();for(const row of data){barcodeDB[row.barcode]={name:row.name||'',category:row.category||'',shelf:row.shelf||'',section:row.section||'',photo:row.image_url||''};if(row.category)categoriesSet.add(row.category)}updateCategoryDatalist()}catch(err){console.warn('Failed to load items from Supabase:',err);barcodeDB={};categoriesSet=new Set();updateCategoryDatalist()}}

function captureFrameDataURL(){try{const c=document.createElement('canvas');c.width=video.videoWidth||640;c.height=video.videoHeight||480;const ctx=c.getContext('2d');ctx.drawImage(video,0,0,c.width,c.height);return c.toDataURL('image/png')}catch(e){console.warn('Failed to capture frame:',e);return null}}

itemPhotoInput.addEventListener('change',e=>{const f=e.target.files&&e.target.files[0];if(!f)return;const r=new FileReader();r.onload=function(ev){const data=ev.target.result;itemPhotoData.value=data;photoPreview.src=data;photoPreview.style.display='block'};r.readAsDataURL(f)});

function startScanner(){lastDetectedCode=null;consecutiveDetectCount=0;acceptCooldown=false;detectBadge.textContent=`0/${CONFIRMATION_THRESHOLD}`;Quagga.init({inputStream:{name:'Live',type:'LiveStream',target:video},decoder:{readers:['ean_reader','upc_reader','code_128_reader']},locate:true},err=>{if(err){console.error(err);return}Quagga.start()});Quagga.onDetected(result=>{if(!result||!result.codeResult)return;const code=result.codeResult.code;if(acceptCooldown)return;if(lastDetectedCode===code)consecutiveDetectCount++;else{lastDetectedCode=code;consecutiveDetectCount=1}if(consecutiveDetectCount>=CONFIRMATION_THRESHOLD){acceptCooldown=true;lastDetectedCode=null;consecutiveDetectCount=0;detectBadge.textContent=`0/${CONFIRMATION_THRESHOLD}`;currentCode=code;const item=barcodeDB[code];if(item){if(item.photo){itemPhotoDisplay.src=item.photo;itemPhotoDisplay.style.display='block'}else if(item.photoPath){itemPhotoDisplay.src=item.photoPath;itemPhotoDisplay.style.display='block'}else itemPhotoDisplay.style.display='none';itemNameDisplay.textContent=item.name;barcodeDisplay.textContent='Barcode: '+code;dateDisplay.textContent='Date of location: '+new Date().toLocaleDateString();shelfDisplay.textContent='Shelf / Section nr: '+item.shelf+' / '+item.section;categoryDisplay.textContent='Category: '+(item.category||'-');switchTab(document.getElementById('tab-map'))}else{itemNameDisplay.textContent='âŒ Not found in database';barcodeDisplay.textContent='Barcode: '+code;dateDisplay.textContent='Date of location: -';shelfDisplay.textContent='';categoryDisplay.textContent='Category: -';itemBarcodeInput.value=code;const dataURL=captureFrameDataURL();if(dataURL){itemPhotoData.value=dataURL;photoPreview.src=dataURL;photoPreview.style.display='block'}else{itemPhotoData.value='';photoPreview.style.display='none'}saveBtn.textContent='ðŸ’¾ Save Item';video.style.display='none';addForm.style.display='flex';itemCard.classList.remove('hidden');stopCamera()}setTimeout(()=>{acceptCooldown=false},700)}})}

function stopCamera(){acceptCooldown=false;lastDetectedCode=null;consecutiveDetectCount=0;detectBadge.style.display='none';torchBtn.style.display='none';if(currentStream){currentStream.getTracks().forEach(track=>track.stop());currentStream=null}if(video.srcObject){try{video.srcObject.getTracks().forEach(t=>t.stop())}catch(e){}video.srcObject=null}if(window.Quagga){try{Quagga.stop()}catch(e){}}
}

async function startCamera(){acceptCooldown=false;lastDetectedCode=null;consecutiveDetectCount=0;detectBadge.textContent=`0/${CONFIRMATION_THRESHOLD}`;try{const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});currentStream=stream;video.srcObject=stream;video.play().catch(()=>{});torchOn=false;startScanner()}catch(err){alert('Error accessing camera: '+err.message)}}

async function toggleTorch(){if(!currentStream){alert('Camera not started');return}const track=currentStream.getVideoTracks()[0];if(!track){alert('No video track available');return}const capabilities=track.getCapabilities?track.getCapabilities():{};if(!capabilities||!capabilities.torch){try{await track.applyConstraints({advanced:[{torch:!torchOn}]});torchOn=!torchOn;torchBtn.textContent=torchOn?'ðŸ”¦':'ðŸ”¦'}catch(err){alert('Torch not supported on this device/browser.')}return}try{await track.applyConstraints({advanced:[{torch:!torchOn}]});torchOn=!torchOn;torchBtn.style.background=torchOn?'rgba(255,255,255,.95)':'rgba(0,0,0,.45)';torchBtn.style.color=torchOn?'#111':'white'}catch(err){console.warn('Torch toggle failed:',err);alert('Failed to toggle torch: '+err.message)}}
torchBtn.addEventListener('click',toggleTorch);

async function resizeDataURL(dataURL,maxWidth=1024,quality=0.75){return new Promise((resolve,reject)=>{const img=new Image();img.onload=()=>{const scale=Math.min(1,maxWidth/img.width);const w=Math.round(img.width*scale);const h=Math.round(img.height*scale);const c=document.createElement('canvas');c.width=w;c.height=h;const ctx=c.getContext('2d');ctx.drawImage(img,0,0,w,h);try{resolve(c.toDataURL('image/jpeg',quality))}catch(err){reject(err)}};
img.onerror=()=>reject(new Error('Failed to load image for resize'));img.crossOrigin='anonymous';img.src=dataURL})}

saveBtn.addEventListener('click',async()=>{try{const name=itemNameInput.value.trim(),category=itemCategoryInput.value.trim(),shelf=itemShelfInput.value.trim(),section=itemSectionInput.value.trim(),barcode=itemBarcodeInput.value.trim();if(!name||!shelf||!section||!barcode||!category){alert('Please fill all fields (Category is required)');return}const inlinePhoto=itemPhotoData.value||null;let uploadDataURL=null;if(inlinePhoto){try{uploadDataURL=await resizeDataURL(inlinePhoto,1024,0.75)}catch(err){console.warn('Resize failed â€” falling back to original photo',err);uploadDataURL=inlinePhoto}}let finalPhotoUrl=null;if(uploadDataURL){try{finalPhotoUrl=await uploadImageToSupabase(barcode,uploadDataURL)}catch(err){console.error('Image upload failed:',err);alert('Image upload failed: '+(err.message||err));return}}else{if(barcodeDB[barcode]&&barcodeDB[barcode].photo)finalPhotoUrl=barcodeDB[barcode].photo;else finalPhotoUrl=null}const itemToSave={name,category,shelf,section,image_url:finalPhotoUrl};await saveItemToSupabase(barcode,itemToSave);if(category){categoriesSet.add(category);updateCategoryDatalist()}await loadDatabaseFromSupabase();const saved=barcodeDB[barcode];if(saved&&saved.photo){itemPhotoDisplay.src=saved.photo;itemPhotoDisplay.style.display='block'}else itemPhotoDisplay.style.display='none';itemNameDisplay.textContent=saved?.name||name;shelfDisplay.textContent='Shelf / Section nr: '+(saved?.shelf||shelf)+' / '+(saved?.section||section);categoryDisplay.textContent='Category: '+(saved?.category||category||'-');addForm.style.display='none';switchTab(document.getElementById('tab-map'));alert('Item saved successfully.')}catch(err){console.error('Save failed:',err);alert('Save failed: '+(err.message||err))}});

mapContainer.style.display='flex';
window.addEventListener('load',async()=>{try{await loadDatabaseFromSupabase()}catch(e){console.warn('Initial load failed',e)}mapImg.style.height='100%';mapImg.style.width='auto';mapImg.style.objectFit='contain';mapImg.style.transform='none';mapImg.style.display='block'});
mapImg.addEventListener('load',()=>{mapImg.style.height='100%';mapImg.style.width='auto';mapImg.style.objectFit='contain';mapImg.style.transform='none';mapImg.style.display='block'});

const photoModal=document.getElementById('photoModal'),modalPhoto=document.getElementById('modalPhoto');
itemPhotoDisplay.addEventListener('click',()=>{if(itemPhotoDisplay&&itemPhotoDisplay.src){modalPhoto.src=itemPhotoDisplay.src;photoModal.style.display='flex'}});photoModal.addEventListener('click',()=>{photoModal.style.display='none';modalPhoto.src=''})

/* map pan/zoom */
let scale=1,minScale=0.1,maxScale=6,panX=0,panY=0,isPanning=false,panStartX=0,panStartY=0,lastPanX=0,lastPanY=0,lastTouchDist=null,lastTouchCenter=null;
function applyTransform(){mapImg.style.transform=`translate(${panX}px, ${panY}px) scale(${scale})`}
function clamp(v,a,b){return Math.max(a,Math.min(b,v))}
mapContainer.addEventListener('wheel',function(e){if(mapContainer.style.display==='none')return;e.preventDefault();const rect=mapImg.getBoundingClientRect();const mx=e.clientX-rect.left;const my=e.clientY-rect.top;const delta=-e.deltaY;const zoomFactor=Math.exp(delta*0.0015);let newScale=clamp(scale*zoomFactor,minScale,maxScale);const scaleRatio=newScale/scale;panX=(panX-mx)*scaleRatio+mx;panY=(panY-my)*scaleRatio+my;scale=newScale;applyTransform()},{passive:false});
mapContainer.addEventListener('pointerdown',function(e){if(e.pointerType==='touch')return;isPanning=true;panStartX=e.clientX;panStartY=e.clientY;lastPanX=panX;lastPanY=panY;mapContainer.setPointerCapture(e.pointerId)});
mapContainer.addEventListener('pointermove',function(e){if(!isPanning)return;const dx=e.clientX-panStartX;const dy=e.clientY-panStartY;panX=lastPanX+dx;panY=lastPanY+dy;applyTransform()});
mapContainer.addEventListener('pointerup',function(e){isPanning=false;try{mapContainer.releasePointerCapture(e.pointerId)}catch(_){}});
mapContainer.addEventListener('pointercancel',function(e){isPanning=false;try{mapContainer.releasePointerCapture(e.pointerId)}catch(_){}});
mapContainer.addEventListener('touchstart',function(e){if(!e.touches)return;if(e.touches.length===1){lastTouchDist=null;const t=e.touches[0];isPanning=true;panStartX=t.clientX;panStartY=t.clientY;lastPanX=panX;lastPanY=panY}else if(e.touches.length===2){isPanning=false;const t0=e.touches[0],t1=e.touches[1];lastTouchDist=Math.hypot(t1.clientX-t0.clientX,t1.clientY-t0.clientY);lastTouchCenter={x:(t0.clientX+t1.clientX)/2,y:(t0.clientY+t1.clientY)/2}}},{passive:false});
mapContainer.addEventListener('touchmove',function(e){if(!e.touches)return;if(e.touches.length===1&&isPanning){e.preventDefault();const t=e.touches[0];const dx=t.clientX-panStartX;const dy=t.clientY-panStartY;panX=lastPanX+dx;panY=lastPanY+dy;applyTransform()}else if(e.touches.length===2){e.preventDefault();const t0=e.touches[0],t1=e.touches[1];const curDist=Math.hypot(t1.clientX-t0.clientX,t1.clientY-t0.clientY);const curCenter={x:(t0.clientX+t1.clientX)/2,y:(t0.clientY+t1.clientY)/2};if(lastTouchDist){const zoomFactor=curDist/lastTouchDist;const newScale=clamp(scale*zoomFactor,minScale,maxScale);const rect=mapImg.getBoundingClientRect();const cx=curCenter.x-rect.left;const cy=curCenter.y-rect.top;const scaleRatio=newScale/scale;panX=(panX-cx)*scaleRatio+cx;panY=(panY-cy)*scaleRatio+cy;scale=newScale;applyTransform()}lastTouchDist=curDist;lastTouchCenter=curCenter}} ,{passive:false});
mapContainer.addEventListener('touchend',function(e){if(!e.touches||e.touches.length===0){isPanning=false;lastTouchDist=null;lastTouchCenter=null}else if(e.touches.length===1){const t=e.touches[0];isPanning=true;panStartX=t.clientX;panStartY=t.clientY;lastPanX=panX;lastPanY=panY;lastTouchDist=null}} ,{passive:false});
window.addEventListener('wheel',function(e){if(e.ctrlKey&&!mapContainer.contains(e.target))e.preventDefault()},{passive:false});
</script>
</body>
</html>
