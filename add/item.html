<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hurtig Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f0f0f0; text-align: center; }
        
        /* Scanner boks */
        #reader { width: 100%; max-width: 500px; margin: 0 auto; border-radius: 10px; overflow: hidden; background: #000; min-height: 300px; display: none; }
        
        .hidden { display: none !important; }
        
        /* Knapper og inputs */
        .input-group { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px; }
        input { width: 90%; padding: 10px; margin: 10px 0; font-size: 16px; border: 1px solid #ddd; border-radius: 5px; }
        
        button { width: 100%; padding: 20px; font-size: 18px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: bold;}
        button.cancel { background: #dc3545; margin-top: 10px; padding: 15px; font-size: 16px; }
        
        #start-btn { background-color: #28a745; margin-top: 50px; }
        
        h2 { margin-top: 0; }
        #status { margin-top: 10px; font-weight: bold; }
        #error-msg { color: red; margin-top: 20px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>üì¶ Varelager Scanner</h1>

    <div id="start-screen">
        <p>Tryk for at aktivere kameraet</p>
        <button id="start-btn" onclick="startCameraClick()">üì∑ Start Scanner</button>
        <p id="error-msg"></p>
    </div>

    <div id="scanner-container" class="hidden">
        <div id="reader"></div>
        <button onclick="stopCamera()" class="cancel" style="background: #555;">Stop Kamera</button>
    </div>

    <div id="result-container" class="hidden">
        <div class="input-group">
            <h2>Stregkode fundet!</h2>
            <input type="text" id="barcode-input" readonly style="background: #eee; color: #555;">
            <input type="text" id="name-input" placeholder="Indtast produktnavn">
            <button onclick="saveProduct()" id="save-btn">Gem Produkt</button>
            <button onclick="resetScanner()" class="cancel">Annuller / Scan Igen</button>
            <p id="status"></p>
        </div>
    </div>

    <script>
       // --- INDS√ÜT DINE N√òGLER HER ---
const SUPABASE_URL = 'DIN_SUPABASE_URL_HER';
const SUPABASE_KEY = 'DIN_SUPABASE_ANON_KEY_HER';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let html5QrCode;

async function startCameraClick() {
    const errorDisplay = document.getElementById('error-msg');
    errorDisplay.innerText = "Pr√∏ver at starte...";

    try {
        // Tjek om browseren overhovedet underst√∏tter kamera-api
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            throw new Error("Din browser underst√∏tter ikke kamera-adgang. Pr√∏v Safari.");
        }

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('scanner-container').classList.remove('hidden');
        document.getElementById('reader').style.display = "block";

        html5QrCode = new Html5Qrcode("reader");

        // Specifikke indstillinger til iPhone 13 Pro Max for at undg√• fokus-problemer
        const config = { 
            fps: 15, 
            qrbox: { width: 250, height: 150 },
            aspectRatio: 1.0 
        };

        // Vi tvinger den til at bruge det bagudvendte kamera
        await html5QrCode.start(
            { facingMode: { exact: "environment" } }, // Pr√∏v f√∏rst tvunget bagkamera
            config,
            onScanSuccess
        );
        
        errorDisplay.innerText = ""; // Ryd fejl hvis det lykkes
    } catch (err) {
        console.error(err);
        // Hvis "exact: environment" fejler (sker p√• nogle browsere), s√• pr√∏v uden "exact"
        try {
            await html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
        } catch (secondErr) {
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('scanner-container').classList.add('hidden');
            errorDisplay.innerText = "Fejl: " + secondErr.message;
            alert("Kamera-fejl: " + secondErr.message);
        }
    }
}

function onScanSuccess(decodedText) {
    // Stop scanningen med det samme s√• den ikke "dobbelt-scanner"
    html5QrCode.pause(true); 
    
    document.getElementById('scanner-container').classList.add('hidden');
    document.getElementById('result-container').classList.remove('hidden');
    
    document.getElementById('barcode-input').value = decodedText;
    document.getElementById('name-input').focus();
}
