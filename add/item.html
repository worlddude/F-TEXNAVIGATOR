<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stregkode Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: sans-serif; margin: 0; background: #f4f4f9; text-align: center; overflow-x: hidden; }
        .header { background: #2563eb; color: white; padding: 15px; font-weight: bold; }
        
        /* Kamera-containeren skal vÃ¦re prÃ¦cis som i din fungerende kode */
        #interactive.viewport { width: 100%; height: 300px; position: relative; overflow: hidden; background: #000; }
        #interactive.viewport video { width: 100%; height: 100%; object-fit: cover; }
        canvas.drawingBuffer { position: absolute; left: 0; top: 0; }

        .hidden { display: none; }
        .card { background: white; margin: 20px; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-primary { background: #2563eb; color: white; }
        .btn-cancel { background: #666; color: white; margin-top: 10px; }
        #status-msg { margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">STREGKODE SCANNER</div>

    <div id="start-screen" class="card">
        <p>Klar til at tilfÃ¸je produkter til Supabase?</p>
        <button class="btn-primary" onclick="initScanner()">ðŸ“· Ã…bn Scanner</button>
    </div>

    <div id="scanner-container" class="hidden">
        <div id="interactive" class="viewport"></div>
        <p>Centrer stregkoden i kameraet</p>
        <button class="btn-cancel" onclick="stopScanner()">Annuller</button>
    </div>

    <div id="result-screen" class="hidden card">
        <h2>Vare fundet!</h2>
        <input type="text" id="barcode-res" readonly style="background: #eee;">
        <input type="text" id="name-input" placeholder="Produktnavn (f.eks. Cola)">
        <button class="btn-primary" id="save-btn" onclick="saveToSupabase()">ðŸ’¾ Gem i Supabase</button>
        <button class="btn-cancel" onclick="resetApp()">Scan en til</button>
        <p id="status-msg"></p>
    </div>

    <script>
        // --- DIN KONFIGURATION ---
        const SUPABASE_URL = 'DIN_SUPABASE_URL';
        const SUPABASE_KEY = 'DIN_SUPABASE_ANON_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let isScanning = false;

        function initScanner() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('scanner-container').classList.remove('hidden');

            // Quagga indstillinger inspireret af din kode
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: "environment", // Brug bagkamera
                        aspectRatio: { min: 1, max: 2 }
                    },
                },
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "upc_reader", "code_128_reader"]
                },
                locate: true // HjÃ¦lper med at finde stregkoden pÃ¥ iPhone 13 Pro
            }, function(err) {
                if (err) {
                    console.error(err);
                    alert("Kamera fejl: " + err);
                    return;
                }
                Quagga.start();
                isScanning = true;
            });

            Quagga.onDetected(function(result) {
                if (!isScanning) return;
                const code = result.codeResult.code;
                
                // Giv visuel/lyd feedback
                if (navigator.vibrate) navigator.vibrate(100);
                
                onFound(code);
            });
        }

        function onFound(code) {
            isScanning = false;
            Quagga.stop();
            
            document.getElementById('scanner-container').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('barcode-res').value = code;
            document.getElementById('name-input').focus();
        }

        async function saveToSupabase() {
            const barcode = document.getElementById('barcode-res').value;
            const name = document.getElementById('name-input').value;
            const btn = document.getElementById('save-btn');
            const status = document.getElementById('status-msg');

            if (!name) return alert("Skriv et navn");

            btn.disabled = true;
            btn.innerText = "Gemmer...";

            const { error } = await supabase
                .from('items') // SÃ¸rg for at din tabel hedder 'items' eller ret det her
                .upsert({ barcode: barcode, name: name });

            if (error) {
                status.innerText = "Fejl: " + error.message;
                status.style.color = "red";
            } else {
                status.innerText = "Gemt med succes!";
                status.style.color = "green";
                setTimeout(resetApp, 1500);
            }
            btn.disabled = false;
            btn.innerText = "Gem i Supabase";
        }

        function stopScanner() {
            Quagga.stop();
            resetApp();
        }

        function resetApp() {
            isScanning = false;
            document.getElementById('start-screen').classList.remove('hidden');
            document.getElementById('scanner-container').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('name-input').value = "";
            document.getElementById('status-msg').innerText = "";
        }
    </script>
</body>
</html>
