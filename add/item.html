<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stregkode-scanner</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111}
    body{max-width:780px;margin:16px auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{font-size:18px;margin:0}
    video{width:100%;border-radius:10px;background:#000}
    button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#f6f6f6}
    button.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    button.toggle{margin-left:6px;font-size:12px}
    button.toggle.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .status{padding:8px;border-radius:8px;background:#eef3ff;min-height:38px}
    .panel{display:grid;grid-template-columns:1fr 300px;gap:12px}
    .right{border-left:1px solid #eee;padding-left:12px;display:flex;flex-direction:column}
    .fields{flex:1}
    .bottom{margin-top:8px}
    label{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-size:13px}
    input{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd}
    ul{padding-left:18px;margin-top:8px}
    @media (max-width:760px){.panel{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <h1>Stregkode-scanner</h1>
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>
</header>

<div class="status" id="status">Klar</div>

<div class="panel">
  <div>
    <video id="video" playsinline muted></video>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <div class="right">
    <div class="fields">
      <label>Stregkode</label>
      <input id="barcodeInput" readonly />

      <label>Produktnavn</label>
      <input id="nameInput" />

      <label>Brand / Producent</label>
      <input id="brandInput" placeholder="fx REMA 1000" />

      <label>Kategori</label>
      <input id="categoryInput" />

      <label>
        Hylde
        <button id="lockShelf" class="toggle">Gem værdi</button>
      </label>
      <input id="shelfInput" placeholder="fx 3" />

      <label>
        Række
        <button id="lockRow" class="toggle">Gem værdi</button>
      </label>
      <input id="rowInput" placeholder="fx B" />

      <label>Oprettelsesdato</label>
      <input id="dateInput" readonly />

      <!-- Gem-knappen er flyttet HER (over listen) -->
      <div class="bottom">
        <button id="saveBtn" class="primary" disabled style="width:100%">Gem produkt</button>
      </div>

      <label>Lokalt scannede</label>
      <ul id="list"></ul>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@zxing/browser@0.1.5"></script>
<script>
// --- KONFIGURATION ---
const SUPABASE_URL = 'https://lpcygniycyffeswzrnms.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxwY3lnbml5Y3lmZmVzd3pybm1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODA5NDIsImV4cCI6MjA3MjY1Njk0Mn0.4bVTsLEwvjyPllLU1-U2vcw3yHkzqj69TZOfuJvSvDQ';
const SUPABASE_TABLE = 'products';
// ---------------------

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const saveBtn = document.getElementById('saveBtn');
const barcodeInput = document.getElementById('barcodeInput');
const nameInput = document.getElementById('nameInput');
const brandInput = document.getElementById('brandInput');
const categoryInput = document.getElementById('categoryInput');
const shelfInput = document.getElementById('shelfInput');
const rowInput = document.getElementById('rowInput');
const dateInput = document.getElementById('dateInput');
const listEl = document.getElementById('list');
const statusEl = document.getElementById('status');
const lockShelfBtn = document.getElementById('lockShelf');
const lockRowBtn = document.getElementById('lockRow');

let stream=null, reader=null, controls=null;
let lastScanned=null;
let localProducts=[];
let lockShelf=false, lockRow=false;
let savedShelf=null, savedRow=null;
let inactivityTimer = null;

function setStatus(t){statusEl.textContent=t}

// toggle lås
lockShelfBtn.onclick=()=>{
  lockShelf=!lockShelf;
  lockShelfBtn.classList.toggle('active',lockShelf);
  savedShelf = lockShelf ? shelfInput.value : null;
};
lockRowBtn.onclick=()=>{
  lockRow=!lockRow;
  lockRowBtn.classList.toggle('active',lockRow);
  savedRow = lockRow ? rowInput.value : null;
};

// start/stop
startBtn.onclick=startScanning;
stopBtn.onclick=stopScanning;
saveBtn.onclick=manualSave;

function resetInactivityTimer(){
  if(inactivityTimer) clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(()=>{
    setStatus('Ingen scanning i 60s — stopper kamera');
    stopScanning();
  }, 60000);
}

async function startScanning(){
  // stop tidligere streams
  try{ if(controls && typeof controls.stop==='function') controls.stop(); }catch(e){}
  try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(e){}

  startBtn.disabled=true;
  setStatus('Starter kamera — tillad venligst adgang');

  // find bagkamera deviceId hvis muligt
  async function findBackDeviceId(){
    try{ const tmp = await navigator.mediaDevices.getUserMedia({video:true}); tmp.getTracks().forEach(t=>t.stop()); }catch(e){}
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d=>d.kind==='videoinput');
    const back = videoDevices.find(d=>/back|rear|environment/i.test(d.label));
    return back ? back.deviceId : (videoDevices.length ? videoDevices[videoDevices.length-1].deviceId : null);
  }

  try{
    let deviceId=null;
    try{ deviceId = await findBackDeviceId(); }catch(e){ deviceId = null; }

    if(deviceId){
      stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId }, width: { ideal: 1280 } } });
    }else{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } } });
    }

    video.srcObject = stream; await video.play(); stopBtn.disabled=false; setStatus('Scanner...');
    resetInactivityTimer();

    // native detector
    if('BarcodeDetector' in window){
      try{
        const detector = new BarcodeDetector({formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code']});
        const ctx = canvas.getContext('2d');
        (async function loop(){
          if(!stream) return;
          try{
            canvas.width = video.videoWidth || 640; canvas.height = video.videoHeight || 480;
            ctx.drawImage(video,0,0,canvas.width,canvas.height);
            const codes = await detector.detect(canvas);
            if(codes && codes.length){ const code = codes[0].rawValue || codes[0].raw_text || ''; if(code) await handleBarcode(code); }
          }catch(e){}
          requestAnimationFrame(loop);
        })();
        return;
      }catch(e){ console.warn('BarcodeDetector fejl — fallback', e); }
    }

    // ZXing fallback
    if(window.ZXingBrowser){
      reader = new ZXingBrowser.BrowserMultiFormatReader();
      const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
      const chosen = devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[devices.length-1] || devices[0];
      controls = await reader.decodeFromVideoDevice(chosen.deviceId, video, async (result, err, ctrl)=>{ if(result) await handleBarcode(result.text); });
    }
  }catch(e){ console.error(e); setStatus('Fejl ved kameraadgang — tjek tilladelser og HTTPS'); startBtn.disabled=false; }
}

async function handleBarcode(code){
  // hvis brugeren allerede har samme stregkode i input (fx manuelt indtastet), så ignorer
  if(barcodeInput.value && barcodeInput.value === code){
    setStatus('Samme stregkode som i input — ignoreret');
    resetInactivityTimer();
    return;
  }

  // debounce mod hurtige gentagelser
  if(lastScanned && lastScanned.code===code && (Date.now()-lastScanned.time)<1500) { resetInactivityTimer(); return; }
  lastScanned = {code, time: Date.now()};

  // sæt inputfelter
  barcodeInput.value = code;
  dateInput.value = new Date().toLocaleString();

  // genbrug låste værdier
  if(lockShelf && savedShelf) shelfInput.value = savedShelf;
  if(lockRow && savedRow) rowInput.value = savedRow;

  // foreslå navn / brand / kategori via Open Food Facts
  try{
    const r = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
    if(r.ok){ const j = await r.json(); if(j.status===1){
      nameInput.value = j.product.product_name_da || j.product.product_name || nameInput.value || '';
      brandInput.value = (j.product.brands || brandInput.value || '');
      categoryInput.value = (j.product.categories_tags?.[0]||categoryInput.value||'').replace('en:','').replace(/-/g,' ');
      setStatus('Produkt fundet — udfyldt forslag');
    } else setStatus('Ingen info fundet'); }
  }catch(e){ console.warn('OFF fejl', e); setStatus('Ingen info fundet'); }

  // aktiver kun manuel gem-knap (auto-gem er fjernet helt)
  saveBtn.disabled = false;
  resetInactivityTimer();
}

function requiredMissing(){
  const need = [];
  if(!barcodeInput.value) need.push('barcode');
  if(!nameInput.value) need.push('name');
  if(!brandInput.value) need.push('brand');
  if(!categoryInput.value) need.push('category');
  if(!shelfInput.value) need.push('shelf');
  if(!rowInput.value) need.push('row');
  return need;
}

async function saveProduct(){
  const missing = requiredMissing();
  if(missing.length){
    setStatus('Fejl: manglende felter - ' + missing.join(', '));
    alert('Fejl: Udfyld felterne: ' + missing.join(', '));
    return;
  }

  const p = {
    barcode: barcodeInput.value,
    name: nameInput.value,
    brand: brandInput.value,
    category: categoryInput.value,
    shelf: shelfInput.value,
    row: rowInput.value,
    created_at: new Date().toISOString()
  };

  localProducts.push(p);
  renderList();
  setStatus('Produkt gemt lokalt');

  // ryd inputs – men behold låste værdier
  barcodeInput.value = '';
  nameInput.value = '';
  brandInput.value = '';
  categoryInput.value = '';
  dateInput.value = '';

  if(!lockShelf) shelfInput.value = '';
  if(!lockRow) rowInput.value = '';

  saveBtn.disabled = true;

  if(localProducts.length>=21){
    if(confirm('Du har 20+ produkter lokalt. Vil du uploade til Supabase nu?')){
      await uploadAll();
    }
  }
}

// manual save handler
async function manualSave(){ await saveProduct(); }

async function uploadAll(){
  if(localProducts.length===0){ setStatus('Ingen produkter at uploade'); return; }
  setStatus('Uploader...');
  try{
    const res = await fetch(`${SUPABASE_URL.replace(/\/+$/,'')}/rest/v1/${SUPABASE_TABLE}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
      },
      body: JSON.stringify(localProducts)
    });
    if(!res.ok){ const text = await res.text(); throw new Error('Supabase svar: '+res.status+' '+text); }
    localProducts = [];
    renderList();
    setStatus('Upload færdig ✔');
  }catch(e){ console.error(e); setStatus('Upload-fejl: ' + e.message); alert('Upload-fejl: ' + e.message); }
}

function renderList(){
  listEl.innerHTML='';
  localProducts.slice().reverse().forEach(p=>{
    const li=document.createElement('li');
    li.textContent = `${p.barcode} | ${p.brand||'-'} | H${p.shelf||'-'} R${p.row||'-'} | ${p.name||''}`;
    listEl.appendChild(li);
  });
}

function stopScanning(){
  try{ if(controls && typeof controls.stop==='function') controls.stop(); }catch(e){}
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  if(inactivityTimer) { clearTimeout(inactivityTimer); inactivityTimer = null; }
  startBtn.disabled=false; stopBtn.disabled=true; setStatus('Stoppet');
}

// ekstra: når brugeren manuelt ændrer låste værdier, opdater saved values
shelfInput.addEventListener('input', ()=>{ if(lockShelf) savedShelf = shelfInput.value; });
rowInput.addEventListener('input', ()=>{ if(lockRow) savedRow = rowInput.value; });

// cleanup on pagehide
window.addEventListener('pagehide', stopScanning);
</script>
</body>
</html>
