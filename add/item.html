<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scanner v2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #111; color: white; text-align: center; }
        #video { width: 100%; max-width: 500px; border-radius: 15px; background: #000; display: none; }
        .btn { background: #2563eb; color: white; padding: 20px; border: none; border-radius: 10px; font-size: 20px; width: 100%; cursor: pointer; }
        .input-card { background: #222; padding: 20px; border-radius: 15px; margin-top: 20px; display: none; }
        input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: none; font-size: 16px; box-sizing: border-box; }
        #status { color: #ff3e3e; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>Hurtig Scan</h1>
    
    <button id="startBtn" class="btn" onclick="activateCamera()">ðŸ“· Ã…BN SCANNER</button>
    
    <video id="video" playsinline></video>
    <p id="status"></p>

    <div id="inputCard" class="input-card">
        <h2>Vare Fundet</h2>
        <input type="text" id="barcodeField" readonly>
        <input type="text" id="nameField" placeholder="Hvad er det?">
        <button class="btn" onclick="uploadData()">GEM I SUPABASE</button>
    </div>

    <script>
        const SUPABASE_URL = 'DIN_URL';
        const SUPABASE_KEY = 'DIN_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const video = document.getElementById('video');
        const status = document.getElementById('status');
        let scannerActive = false;

        async function activateCamera() {
            status.innerText = "Anmoder om adgang...";
            
            try {
                // Her tvinger vi Chrome til at spÃ¸rge om lov
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.style.display = "block";
                video.play();
                
                document.getElementById('startBtn').style.display = "none";
                scannerActive = true;
                status.innerText = "Scanner kÃ¸rer...";
                
                // Start selve genkendelsen
                scanFrame();
            } catch (err) {
                status.innerText = "FEJL: " + err.message;
                console.error(err);
                alert("Du skal give Chrome lov til at bruge kameraet i dine iPhone-indstillinger!");
            }
        }

        async function scanFrame() {
            if (!scannerActive) return;

            // Tjek om browseren har BarcodeDetector (Nyere Chrome/Safari)
            if ('BarcodeDetector' in window) {
                const detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'code_128'] });
                try {
                    const barcodes = await detector.detect(video);
                    if (barcodes.length > 0) {
                        foundCode(barcodes[0].rawValue);
                        return;
                    }
                } catch (e) {
                    console.error("Detector fejl", e);
                }
            }
            
            // Hvis BarcodeDetector ikke er klar endnu, prÃ¸v igen om 100ms
            requestAnimationFrame(scanFrame);
        }

        function foundCode(code) {
            scannerActive = false;
            // Stop kamera-strÃ¸mmen helt
            video.srcObject.getTracks().forEach(track => track.stop());
            video.style.display = "none";
            
            document.getElementById('barcodeField').value = code;
            document.getElementById('inputCard').style.display = "block";
            document.getElementById('nameField').focus();
            
            // Vibration feedback
            if (navigator.vibrate) navigator.vibrate(200);
        }

        async function uploadData() {
            const barcode = document.getElementById('barcodeField').value;
            const name = document.getElementById('nameField').value;
            
            if (!name) return alert("Skriv et navn, mand!");

            const { error } = await supabase
                .from('items') // SÃ¸rg for at din tabel hedder 'items' [cite: 13]
                .insert([{ barcode, name }]);

            if (error) {
                alert("Fejl: " + error.message);
            } else {
                alert("Varen er gemt!");
                location.reload(); // Genstart appen
            }
        }
    </script>
</body>
</html>
