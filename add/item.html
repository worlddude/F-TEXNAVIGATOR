<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stregkode-scanner</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111}
    body{max-width:780px;margin:16px auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{font-size:18px;margin:0}
    .video-wrap{position:relative}
    video{width:100%;border-radius:10px;background:#000}
    #photoBtn{position:absolute;top:10px;right:10px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,5,0.15);background:#fff}
    button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#f6f6f6}
    button.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    button.toggle{margin-left:6px;font-size:12px}
    button.toggle.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .status{padding:8px;border-radius:8px;background:#eef3ff;min-height:38px}
    .panel{display:grid;grid-template-columns:1fr 320px;gap:12px}
    .right{border-left:1px solid #eee;padding-left:12px;display:flex;flex-direction:column}
    .fields{flex:1}
    .bottom{margin-top:8px}
    label{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-size:13px}
    input{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd}
    ul{padding-left:18px;margin-top:8px}
    img.preview{display:block;width:64px;height:64px;object-fit:cover;border-radius:8px;margin-top:8px}
    @media (max-width:760px){.panel{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <h1>Stregkode-scanner</h1>
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
  </div>
</header>

<div class="status" id="status">Klar</div>

<div class="panel">
  <div>
    <div class="video-wrap">
      <video id="video" playsinline muted></video>
      <button id="photoBtn" title="Tag billede">ðŸ“¸</button>
    </div>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <div class="right">
    <div class="fields">
      <label>Stregkode</label>
      <input id="barcodeInput" readonly />

      <label>Produktnavn</label>
      <input id="nameInput" />

      <label>Brand / Producent</label>
      <input id="brandInput" placeholder="fx REMA 1000" />

      <label>SÃ¸geord</label>
      <input id="categoryInput" />

      <label>
        Hylde
        <button id="lockShelf" class="toggle">Gem vÃ¦rdi</button>
      </label>
      <input id="shelfInput" placeholder="fx 3" />

      <label>
        RÃ¦kke
        <button id="lockRow" class="toggle">Gem vÃ¦rdi</button>
      </label>
      <input id="rowInput" placeholder="fx B" />

      <label>Oprettelsesdato</label>
      <input id="dateInput" readonly />

      <!-- Gem-knap + preview -->
      <div class="bottom">
        <button id="saveBtn" class="primary" disabled style="width:100%">Gem produkt</button>
        <div id="imageArea">
          <small>Billede:</small>
          <img id="imagePreview" class="preview" src="" alt="Ingen" style="display:none" />
        </div>
      </div>

      <label>Lokalt scannede</label>
      <ul id="list"></ul>
    </div>
  </div>
</div>

<!-- ZXing fallback og Supabase JS -->
<script src="https://unpkg.com/@zxing/browser@0.1.5"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
<script>
// --- KONFIGURATION ---
const SUPABASE_URL = 'https://lpcygniycyffeswzrnms.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxwY3lnbml5Y3lmZmVzd3pybm1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODA5NDIsImV4cCI6MjA3MjY1Njk0Mn0.4bVTsLEwvjyPllLU1-U2vcw3yHkzqj69TZOfuJvSvDQ';
const SUPABASE_TABLE = 'products';
const SUPABASE_BUCKET = 'product-images'; // <--- opret denne bucket i Supabase Storage
// ---------------------

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const saveBtn = document.getElementById('saveBtn');
const photoBtn = document.getElementById('photoBtn');
const barcodeInput = document.getElementById('barcodeInput');
const nameInput = document.getElementById('nameInput');
const brandInput = document.getElementById('brandInput');
const categoryInput = document.getElementById('categoryInput');
const shelfInput = document.getElementById('shelfInput');
const rowInput = document.getElementById('rowInput');
const dateInput = document.getElementById('dateInput');
const listEl = document.getElementById('list');
const statusEl = document.getElementById('status');
const lockShelfBtn = document.getElementById('lockShelf');
const lockRowBtn = document.getElementById('lockRow');
const imagePreview = document.getElementById('imagePreview');

let stream=null, reader=null, controls=null;
let lastScanned=null;
let localProducts=[];
let lockShelf=false, lockRow=false;
let savedShelf=null, savedRow=null;
let inactivityTimer = null;
let lastUploadedImageUrl = null; // url for image uploaded by user
let openfoodImageUrl = null; // url from Open Food Facts

function setStatus(t){statusEl.textContent=t}

// toggle lÃ¥s
lockShelfBtn.onclick=()=>{
  lockShelf=!lockShelf;
  lockShelfBtn.classList.toggle('active',lockShelf);
  savedShelf = lockShelf ? shelfInput.value : null;
};
lockRowBtn.onclick=()=>{
  lockRow=!lockRow;
  lockRowBtn.classList.toggle('active',lockRow);
  savedRow = lockRow ? rowInput.value : null;
};

// start/stop
startBtn.onclick=startScanning;
stopBtn.onclick=stopScanning;
saveBtn.onclick=manualSave;
photoBtn.onclick=takePhotoAndUpload;

function resetInactivityTimer(){
  if(inactivityTimer) clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(()=>{
    setStatus('Ingen scanning i 60s â€” stopper kamera');
    stopScanning();
  }, 60000);
}

async function startScanning(){
  // stop tidligere streams
  try{ if(controls && typeof controls.stop==='function') controls.stop(); }catch(e){}
  try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(e){}

  startBtn.disabled=true;
  setStatus('Starter kamera â€” tillad venligst adgang');

  // find bagkamera deviceId hvis muligt
  async function findBackDeviceId(){
    try{ const tmp = await navigator.mediaDevices.getUserMedia({video:true}); tmp.getTracks().forEach(t=>t.stop()); }catch(e){}
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d=>d.kind==='videoinput');
    const back = videoDevices.find(d=>/back|rear|environment/i.test(d.label));
    return back ? back.deviceId : (videoDevices.length ? videoDevices[videoDevices.length-1].deviceId : null);
  }

  try{
    let deviceId=null;
    try{ deviceId = await findBackDeviceId(); }catch(e){ deviceId = null; }

    if(deviceId){
      stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId }, width: { ideal: 1280 } } });
    }else{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } } });
    }

    video.srcObject = stream; await video.play(); stopBtn.disabled=false; setStatus('Scanner...');
    resetInactivityTimer();

    // native detector
    if('BarcodeDetector' in window){
      try{
        const detector = new BarcodeDetector({formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code']});
        const ctx = canvas.getContext('2d');
        (async function loop(){
          if(!stream) return;
          try{
            canvas.width = video.videoWidth || 640; canvas.height = video.videoHeight || 480;
            ctx.drawImage(video,0,0,canvas.width,canvas.height);
            const codes = await detector.detect(canvas);
            if(codes && codes.length){ const code = codes[0].rawValue || codes[0].raw_text || ''; if(code) await handleBarcode(code); }
          }catch(e){}
          requestAnimationFrame(loop);
        })();
        return;
      }catch(e){ console.warn('BarcodeDetector fejl â€” fallback', e); }
    }

    // ZXing fallback
    if(window.ZXingBrowser){
      reader = new ZXingBrowser.BrowserMultiFormatReader();
      const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
      const chosen = devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[devices.length-1] || devices[0];
      controls = await reader.decodeFromVideoDevice(chosen.deviceId, video, async (result, err, ctrl)=>{ if(result) await handleBarcode(result.text); });
    }
  }catch(e){ console.error(e); setStatus('Fejl ved kameraadgang â€” tjek tilladelser og HTTPS'); startBtn.disabled=false; }
}

async function handleBarcode(code){
  if(barcodeInput.value && barcodeInput.value === code){
    setStatus('Scannet');
    resetInactivityTimer();
    return;
  }

  if(lastScanned && lastScanned.code===code && (Date.now()-lastScanned.time)<1500) { resetInactivityTimer(); return; }
  lastScanned = {code, time: Date.now()};

  barcodeInput.value = code;
  dateInput.value = new Date().toLocaleString();

  if(lockShelf && savedShelf) shelfInput.value = savedShelf;
  if(lockRow && savedRow) rowInput.value = savedRow;

  // reset previous image urls
  lastUploadedImageUrl = null;
  openfoodImageUrl = null;
  imagePreview.style.display = 'none';
  imagePreview.src = '';

  try{
    const r = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
    if(r.ok){ const j = await r.json(); if(j.status===1){
      nameInput.value = j.product.product_name_da || j.product.product_name || nameInput.value || '';
      brandInput.value = (j.product.brands || brandInput.value || '');
      categoryInput.value = (j.product.categories_tags?.[0]||categoryInput.value||'').replace('en:','').replace(/-/g,' ');
      // image (front)



      
      // ------ billede: vÃ¦lg den bedst mulige url fra Open Food Facts -------
const tryGetSelectedImage = (prod) => {
  try{
    const sel = prod.selected_images;
    if(sel && sel.front){
      const front = sel.front;
      // 1) prÃ¦ferÃ©r 'display' stÃ¸rrelser (kan vÃ¦re organiseret per sprog)
      const display = front.display || front['display'];
      if(display){
        // prÃ¸v dansk, engelsk, fransk, sÃ¥ fallback til fÃ¸rste sprog
        const langs = ['da','en','fr'];
        for(const lg of langs){ if(display[lg]) return display[lg]; }
        const keys = Object.keys(display);
        if(keys.length) return display[keys[0]];
      }
      // 2) fallback til almindelige felter i front-objektet
      if(front.image_url) return front.image_url;
      if(front.url) return front.url;
    }
  }catch(e){}
  return null;
};

openfoodImageUrl = tryGetSelectedImage(j.product)
  || j.product.image_front_1000_url
  || j.product.image_front_url
  || j.product.image_front_small_url
  || j.product.image_front_thumb_url
  || null;

if(openfoodImageUrl){
  // heuristik: hvis URL indeholder et OpenFoodFacts-stÃ¸rrelsessuffiks som ".62.100.jpg"
  // forsÃ¸ger vi at fjerne det for at hente en stÃ¸rre original (kan virke for mange OF URLs).
  try{
    const maybeBigger = openfoodImageUrl.replace(/\.(\d+)\.(\d+)(\.[a-z]{3,4})$/, '$3');
    if(maybeBigger && maybeBigger !== openfoodImageUrl && /^https?:\/\//.test(maybeBigger)){
      openfoodImageUrl = maybeBigger;
    }
  }catch(e){}
  imagePreview.src = openfoodImageUrl;
  imagePreview.style.display = 'block';
} else {
  // hvis intet billede fundet i Open Food Facts => alert + status
  setStatus('Der blev ikke fundet et billede i Open Food Facts for dette produkt. Du kan tage et billede med ðŸ“¸.');
}
setStatus('Produkt fundet â€” udfyldt forslag');
// -------------------------------------------------------------------
  
    } else setStatus('Ingen info fundet'); }
  }catch(e){ console.warn('OFF fejl', e); setStatus('Ingen info fundet'); }

  saveBtn.disabled = false;
  resetInactivityTimer();
}

function requiredMissing(){
  const need = [];
  if(!barcodeInput.value) need.push('barcode');
  if(!nameInput.value) need.push('name');
  if(!brandInput.value) need.push('brand');
  if(!categoryInput.value) need.push('category');
  if(!shelfInput.value) need.push('shelf');
  if(!rowInput.value) need.push('row');
  return need;
}

async function saveProduct(){
  const missing = requiredMissing();
  if(missing.length){
    setStatus('Fejl: manglende felter - ' + missing.join(', '));
    alert('Fejl: Udfyld felterne: ' + missing.join(', '));
    return;
  }

  const imageUrlToSave = lastUploadedImageUrl || openfoodImageUrl || null;

  const p = {
    barcode: barcodeInput.value,
    name: nameInput.value,
    brand: brandInput.value,
    category: categoryInput.value,
    shelf: shelfInput.value,
    row: rowInput.value,
    image_url: imageUrlToSave,
    created_at: new Date().toISOString()
  };

  localProducts.push(p);
  renderList();
  setStatus('Produkt gemt lokalt');

  // ryd inputs â€“ men behold lÃ¥ste vÃ¦rdier og preview
  barcodeInput.value = '';
  nameInput.value = '';
  brandInput.value = '';
  categoryInput.value = '';
  dateInput.value = '';

  if(!lockShelf) shelfInput.value = '';
  if(!lockRow) rowInput.value = '';

  // don't clear preview if user uploaded their own picture; keep it until next scan
  if(!lastUploadedImageUrl){ imagePreview.style.display='none'; imagePreview.src=''; }

  saveBtn.disabled = true;

  if(localProducts.length>=2){
    if(confirm('Du har 20+ produkter lokalt. Vil du uploade til Supabase nu?')){
      await uploadAll();
    }
  }
}

async function manualSave(){ await saveProduct(); }

async function uploadAll(){
  if(localProducts.length===0){ setStatus('Ingen produkter at uploade'); return; }
  setStatus('Uploader...');
  try{
    const res = await fetch(`${SUPABASE_URL.replace(/\/+$/,'')}/rest/v1/${SUPABASE_TABLE}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY
      },
      body: JSON.stringify(localProducts)
    });
    if(!res.ok){ const text = await res.text(); throw new Error('Supabase svar: '+res.status+' '+text); }
    localProducts = [];
    renderList();
    setStatus('Upload fÃ¦rdig âœ”');
  }catch(e){ console.error(e); setStatus('Upload-fejl: ' + e.message); alert('Upload-fejl: ' + e.message); }
}

function renderList(){
  listEl.innerHTML='';
  localProducts.slice().reverse().forEach(p=>{
    const li=document.createElement('li');
    li.textContent = `${p.barcode} | ${p.brand||'-'} | H${p.shelf||'-'} R${p.row||'-'} | ${p.name||''}`;
    listEl.appendChild(li);
  });
}

async function takePhotoAndUpload(){
  if(!stream){ alert('Kamera er ikke startet'); return; }
  // tegn video til canvas i passende stÃ¸rrelse
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);

  // konverter til blob
  canvas.toBlob(async (blob) => {
    if(!blob){ alert('Kunne ikke tage billede'); return; }
    const filename = `product-${Date.now()}-${Math.random().toString(36).slice(2,9)}.jpg`;
    const path = `${filename}`;

    setStatus('Uploader billede...');
    try{
      const { data, error } = await supabaseClient.storage.from(SUPABASE_BUCKET).upload(path, blob, { contentType: 'image/jpeg' });
      if(error){ throw error; }
      // fÃ¥ public url
      const { data: urlData, error: urlErr } = supabaseClient.storage.from(SUPABASE_BUCKET).getPublicUrl(path);
      if(urlErr) throw urlErr;
      const publicUrl = urlData.publicUrl || urlData.publicURL || (urlData?.publicUrl);
      lastUploadedImageUrl = publicUrl;
      imagePreview.src = publicUrl;
      imagePreview.style.display = 'block';
      setStatus('Billede uploadet');
    }catch(e){ console.error(e); setStatus('Upload-fejl: '+e.message); alert('Upload-fejl: '+e.message); }
  }, 'image/jpeg', 0.85);
}

function stopScanning(){
  try{ if(controls && typeof controls.stop==='function') controls.stop(); }catch(e){}
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  if(inactivityTimer) { clearTimeout(inactivityTimer); inactivityTimer = null; }
  startBtn.disabled=false; stopBtn.disabled=true; setStatus('Stoppet');
}

// ekstra: nÃ¥r brugeren manuelt Ã¦ndrer lÃ¥ste vÃ¦rdier, opdater saved values
shelfInput.addEventListener('input', ()=>{ if(lockShelf) savedShelf = shelfInput.value; });
rowInput.addEventListener('input', ()=>{ if(lockRow) savedRow = rowInput.value; });

// cleanup on pagehide
window.addEventListener('pagehide', stopScanning);
</script>
</body>
</html>
