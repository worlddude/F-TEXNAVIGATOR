<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stregkode-scanner — simplified</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --muted:#6b7280;
      --accent:#3b82f6; --accent-dark:#2563eb; --radius:12px;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:#111;
    }
    html,body{height:100%;margin:0;background:var(--bg)}
    .app{max-width:420px;margin:20px auto;padding:16px;display:flex;flex-direction:column;gap:14px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 20px rgba(16,24,40,0.06);padding:14px}
    h1{font-size:18px;margin:0 0 6px 0}
    .small{font-size:13px;color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center}
    .stage{height:420px;border-radius:12px;overflow:hidden;position:relative;background:#0f1724;color:#fff}
    video, img.preview{width:100%;height:100%;object-fit:cover;display:block}
    .overlay{position:absolute;inset:0;pointer-events:none}
    .topbar{position:absolute;top:12px;left:12px;right:12px;display:flex;justify-content:space-between;align-items:center;pointer-events:auto}
    .chip{background:rgba(255,255,255,0.12);padding:8px 12px;border-radius:999px;font-weight:600}
    .bottom{position:absolute;left:0;right:0;bottom:18px;display:flex;justify-content:center;pointer-events:auto}
    .btn{padding:12px 18px;border-radius:40px;border:0;background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;font-weight:600;box-shadow:0 6px 18px rgba(59,130,246,0.25)}
    .ghost{background:rgba(255,255,255,0.12)}
    .message{position:absolute;left:12px;bottom:120px;background:rgba(255,255,255,0.95);color:#111;padding:10px 12px;border-radius:10px;pointer-events:auto;box-shadow:0 8px 20px rgba(2,6,23,0.08)}
    .page{display:none}
    .page.active{display:block}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(16,24,40,0.06);font-size:15px}
    .form-row{margin-top:8px}
    .bottom-actions{display:flex;gap:8px;margin-top:12px}
    .save{flex:1;background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;border-radius:12px;padding:10px 12px;border:0;font-weight:700;cursor:pointer}
    .secondary{background:transparent;border-radius:12px;padding:10px 12px;border:1px solid rgba(16,24,40,0.06);cursor:pointer}
    ul.local-list{margin:0;padding-left:14px;color:var(--muted);font-size:13px;max-height:120px;overflow:auto}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Stregkode-scanner</h1>
      <div id="status" class="small" style="margin-bottom:8px">Klar — tryk Start kamera</div>

      <!-- Start page -->
      <div id="page-start" class="page active">
        <div class="card center" style="padding:28px;border-radius:12px;background:#0f1724;color:#fff">
          <div style="text-align:center">
            <div style="font-weight:700;font-size:16px;margin-bottom:12px">Kamera ikke aktiv</div>
            <div class="small" style="opacity:0.9;margin-bottom:20px">Tryk for at starte kameraet og scanne stregkoder</div>
            <button id="startCameraBtn" class="btn">Start kamera</button>
          </div>
        </div>
      </div>

      <!-- Scan page -->
      <div id="page-scan" class="page">
        <div class="stage card" style="padding:0;background:#061123;">
          <video id="video" playsinline muted></video>
          <div class="overlay">
            <div class="topbar">
              <div class="chip" id="chip-barcode">Hold kamera over stregkoden</div>
              <div style="display:flex;gap:8px">
                <button id="stopCameraBtn" class="chip" title="Stop kamera" style="pointer-events:auto;background:rgba(255,255,255,0.08)">Stop</button>
              </div>
            </div>

            <div id="scanMessage" class="message" style="display:none">
              <div id="scanStatus">Barcode scannet!</div>
              <div id="scanCode" style="font-weight:700;margin-top:4px"></div>
              <div style="margin-top:8px">
                <button id="takePhotoBtn" class="btn" style="pointer-events:auto;margin-top:8px">Tag billede</button>
              </div>
            </div>

            <div class="bottom">
              <button id="btnHoldScan" class="btn ghost" style="pointer-events:auto">Hold for at scanne</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Photo preview -->
      <div id="page-photo" class="page">
        <div class="stage card" style="background:#0b1220;padding:0">
          <img id="previewImg" class="preview" src="" alt="Forhåndsvisning" />
          <div class="overlay">
            <div class="topbar">
              <div class="chip">Billede</div>
            </div>
            <div class="bottom">
              <button id="retakeBtn" class="btn ghost" style="margin-right:8px;pointer-events:auto">Tag om</button>
              <button id="acceptPhotoBtn" class="btn" style="pointer-events:auto">Godkend billede</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit page -->
      <div id="page-edit" class="page">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <div style="flex:0 0 88px">
            <img id="editPreview" src="" alt="Produkt" style="width:88px;height:88px;object-fit:cover;border-radius:10px;border:1px solid rgba(16,24,40,0.04)"/>
          </div>
          <div style="flex:1">
            <div style="font-weight:800" id="editBarcodeLabel">—</div>
            <div class="small" id="editTimestamp">—</div>
          </div>
        </div>

        <label>Produktnavn</label>
        <div class="form-row">
          <input id="field_name" type="text" placeholder="Produktnavn" />
        </div>

        <label>Producent / brand</label>
        <div class="form-row">
          <input id="field_brand" type="text" placeholder="Brand" />
        </div>

        <label>Søgeord</label>
        <div class="form-row">
          <input id="field_category" type="text" placeholder="fx ketchup" />
        </div>

        <label>Placering (hylde)</label>
        <div class="form-row">
          <input id="field_shelf" type="text" placeholder="fx 42" />
        </div>

        <div class="bottom-actions">
          <button id="saveProductBtn" class="save">Gem produkt lokalt</button>
          <button id="backToScanBtn" class="secondary">Tilbage</button>
        </div>

        <div style="margin-top:12px">
          <div class="small" style="margin-bottom:6px">Lokalt scannede (sidste)</div>
          <ul id="localList" class="local-list"></ul>
        </div>
      </div>

    </div>
  </div>

  <!-- ZXing fallback -->
  <script src="https://unpkg.com/@zxing/browser@0.1.5"></script>

  <script>
    // Elements
    const pageStart = document.getElementById('page-start');
    const pageScan = document.getElementById('page-scan');
    const pagePhoto = document.getElementById('page-photo');
    const pageEdit = document.getElementById('page-edit');
    const statusEl = document.getElementById('status');
    const video = document.getElementById('video');
    const previewImg = document.getElementById('previewImg');
    const editPreview = document.getElementById('editPreview');
    const editBarcodeLabel = document.getElementById('editBarcodeLabel');
    const editTimestamp = document.getElementById('editTimestamp');
    const chipBarcode = document.getElementById('chip-barcode');
    const scanMessage = document.getElementById('scanMessage');
    const scanStatus = document.getElementById('scanStatus');
    const scanCode = document.getElementById('scanCode');
    const localList = document.getElementById('localList');

    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const btnHoldScan = document.getElementById('btnHoldScan');
    const takePhotoBtn = document.getElementById('takePhotoBtn');
    const acceptPhotoBtn = document.getElementById('acceptPhotoBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const backToScanBtn = document.getElementById('backToScanBtn');
    const saveProductBtn = document.getElementById('saveProductBtn');

    const field_name = document.getElementById('field_name');
    const field_brand = document.getElementById('field_brand');
    const field_category = document.getElementById('field_category');
    const field_shelf = document.getElementById('field_shelf');

    // internal
    let stream = null;
    let reader = null, controls = null;
    let canvas = document.createElement('canvas');
    let lastScanned = null;
    let currentBarcode = '';
    let openfoodData = null; // store OFF data for autofill (but we won't use OFF image)
    let localProducts = [];

    function showPage(el){
      [pageStart,pageScan,pagePhoto,pageEdit].forEach(p=>p.classList.remove('active'));
      el.classList.add('active');
    }
    function setStatus(txt){ statusEl.textContent = txt; }

    async function findBackDeviceId(){
      try{ const tmp = await navigator.mediaDevices.getUserMedia({video:true}); tmp.getTracks().forEach(t=>t.stop()); }catch(e){}
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d=>d.kind==='videoinput');
      const back = videoDevices.find(d=>/back|rear|environment/i.test(d.label));
      return back ? back.deviceId : (videoDevices.length ? videoDevices[videoDevices.length-1].deviceId : null);
    }

    async function startCamera(){
      showPage(pageScan);
      setStatus('Starter kamera — tillad adgang');
      try{
        const deviceId = await findBackDeviceId();
        if(deviceId){
          stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId }, width: { ideal: 1280 } } });
        } else {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } } });
        }
        video.srcObject = stream;
        await video.play();
        setStatus('Scanner efter stregkoder...');
        runDetectionLoop();
      }catch(e){
        console.error(e);
        setStatus('Fejl ved kameraadgang — tjek tilladelser og HTTPS');
        showPage(pageStart);
      }
    }

    function stopCamera(){
      try{ if(controls && typeof controls.stop==='function') controls.stop(); }catch(e){}
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      showPage(pageStart);
      setStatus('Kamera stoppet');
    }

    async function runDetectionLoop(){
      scanMessage.style.display = 'none';
      chipBarcode.textContent = 'Hold kamera over stregkoden';

      if('BarcodeDetector' in window){
        try{
          const detector = new BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39'] });
          const ctx = canvas.getContext('2d');
          (async function loop(){
            if(!stream) return;
            try{
              canvas.width = video.videoWidth || 640; canvas.height = video.videoHeight || 480;
              ctx.drawImage(video,0,0,canvas.width,canvas.height);
              const codes = await detector.detect(canvas);
              if(codes && codes.length){
                const code = codes[0].rawValue || codes[0].raw_text || '';
                if(code) await handleBarcode(code);
              }
            }catch(e){}
            requestAnimationFrame(loop);
          })();
          return;
        }catch(e){
          console.warn('BarcodeDetector fejl — fallback', e);
        }
      }

      // ZXing fallback
      if(window.ZXingBrowser){
        reader = new ZXingBrowser.BrowserMultiFormatReader();
        const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
        const chosen = (devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[devices.length-1] || devices[0]);
        controls = await reader.decodeFromVideoDevice(chosen.deviceId, video, async (result, err, ctrl) => {
          if(result && result.text) await handleBarcode(result.text);
        });
      } else {
        setStatus('Ingen barcode-detektor tilgængelig');
      }
    }

    async function handleBarcode(code){
      // debounce rapid repeats
      if(currentBarcode === code && Date.now() - (lastScanned?.time || 0) < 1500) return;
      lastScanned = { code, time: Date.now() };
      currentBarcode = code;

      // show message and option to take photo (do not auto-navigate)
      scanStatus.textContent = 'Barcode scannet!';
      scanCode.textContent = code;
      scanMessage.style.display = 'block';
      chipBarcode.textContent = `Stregkode: ${code}`;

      // fill edit header values
      editBarcodeLabel.textContent = code;
      editTimestamp.textContent = new Date().toLocaleString();

      // clear previous OFF data and preview
      openfoodData = null;
      editPreview.src = '';
      previewImg.src = '';

      // Try to fetch info from OpenFoodFacts (only to autofill fields name/brand)
      try{
        const r = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
        if(r.ok){
          const j = await r.json();
          if(j.status === 1){
            openfoodData = j.product;
            // autofill name and brand when moving to edit (but do NOT set or replace image)
            field_name.value = j.product.product_name_da || j.product.product_name || field_name.value || '';
            field_brand.value = (j.product.brands || field_brand.value || '');
            field_category.value = (j.product.categories_tags?.[0]||field_category.value||'').replace('en:','').replace(/-/g,' ');
            setStatus('Produktforslag hentet fra OpenFoodFacts');
          } else {
            setStatus('Ingen info i OpenFoodFacts');
          }
        }
      }catch(e){
        console.warn('OFF fejl', e);
        setStatus('OFF: kunne ikke hente info');
      }

      // Stop continuous ZXing controls to avoid double scans while user decides
      try{ if(controls && typeof controls.stop==='function') controls.stop(); controls = null; }catch(e){}
    }

    // one-shot "hold to scan" attempt
    btnHoldScan.addEventListener('click', async () => {
      setStatus('Holder scanning — prøver at scanne nu');
      try{
        canvas.width = video.videoWidth || 640; canvas.height = video.videoHeight || 480;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        if('BarcodeDetector' in window){
          const detector = new BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39'] });
          const codes = await detector.detect(canvas);
          if(codes && codes.length) return handleBarcode(codes[0].rawValue || codes[0].raw_text || '');
        }
        setStatus('Kunne ikke scanne direkte — prøv igen');
      }catch(e){ console.warn(e); setStatus('Fejl under scanning'); }
    });

    // Take photo button (shown when barcode scanned)
    takePhotoBtn.addEventListener('click', async () => {
      setStatus('Tager billede — hold øje');
      if(!stream){
        setStatus('Intet kamera aktivt');
        return;
      }
      // draw frame to canvas and show preview
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      previewImg.src = canvas.toDataURL('image/jpeg', 0.85);
      // show preview page (user can accept or retake)
      showPage(pagePhoto);
      setStatus('Forhåndsvisning — godkend eller tag om');
    });

    // Accept preview: go to edit page (we do NOT upload anywhere)
    acceptPhotoBtn.addEventListener('click', () => {
      editPreview.src = previewImg.src || '';
      // fill barcode label & timestamp (already set in handleBarcode, but ensure)
      editBarcodeLabel.textContent = currentBarcode || editBarcodeLabel.textContent || '—';
      editTimestamp.textContent = new Date().toLocaleString();
      showPage(pageEdit);
      setStatus('Rediger produktinfo');
      // Keep camera off to save resources
      try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(e){}
    });

    // retake: restart camera and go back to scan
    retakeBtn.addEventListener('click', async () => {
      // re-open camera
      await startCamera();
      scanMessage.style.display = 'none';
      setStatus('Scanner efter stregkoder...');
    });

    backToScanBtn.addEventListener('click', async () => {
      // restart camera for next scan
      await startCamera();
    });

    // Save product locally
    saveProductBtn.addEventListener('click', () => {
      const barcode = editBarcodeLabel.textContent;
      const name = field_name.value.trim();
      const brand = field_brand.value.trim();
      const category = field_category.value.trim();
      const shelf = field_shelf.value.trim();

      if(!barcode || !name || !brand){
        alert('Udfyld venligst stregkode, navn og brand.');
        return;
      }
      const p = {
        barcode, name, brand, category, shelf,
        image_preview: editPreview.src || null,
        created_at: new Date().toISOString()
      };
      localProducts.push(p);
      renderLocalList();
      setStatus('Produkt gemt lokalt');

      // reset fields for next scan
      field_name.value = '';
      field_brand.value = '';
      field_category.value = '';
      field_shelf.value = '';
      editBarcodeLabel.textContent = '—';
      editTimestamp.textContent = '—';
      editPreview.src = '';

      showPage(pageStart);
    });

    function renderLocalList(){
      localList.innerHTML = '';
      [...localProducts].reverse().slice(0,20).forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.barcode} • ${p.brand || '-'} • H:${p.shelf || '-'} • ${p.name || '-'}`;
        localList.appendChild(li);
      });
    }

    // Basic start/stop buttons
    startCameraBtn.addEventListener('click', startCamera);
    stopCameraBtn.addEventListener('click', stopCamera);

    // on page hide, stop camera
    window.addEventListener('pagehide', () => {
      try{ if(controls && typeof controls.stop==='function') controls.stop(); }catch(e){}
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    });

    // initial UI
    showPage(pageStart);
    setStatus('Klar — tryk Start kamera');
  </script>
</body>
</html>
