<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stregkode-scanner + Supabase</title>
  <style>
    :root{
      --bg:#f6f7f9; --card:#fff; --muted:#6b7280;
      --accent:#3b82f6; --accent-dark:#2563eb; --radius:12px;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      color:#111;
    }
    html,body{height:100%;margin:0;background:var(--bg)}
    .app{max-width:420px;margin:20px auto;padding:16px;display:flex;flex-direction:column;gap:14px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:0 6px 20px rgba(16,24,40,0.06);padding:14px}
    h1{font-size:18px;margin:0 0 6px 0}
    .small{font-size:13px;color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center}
    .stage{height:420px;border-radius:12px;overflow:hidden;position:relative;background:#0f1724;color:#fff}
    video, img.preview{width:100%;height:100%;object-fit:cover;display:block}
    .overlay{position:absolute;inset:0;pointer-events:none}
    .topbar{position:absolute;top:12px;left:12px;right:12px;display:flex;justify-content:space-between;align-items:center;pointer-events:auto}
    .chip{background:rgba(255,255,255,0.12);padding:8px 12px;border-radius:999px;font-weight:600}
    .bottom{position:absolute;left:0;right:0;bottom:18px;display:flex;justify-content:center;pointer-events:auto}
    .btn{padding:12px 18px;border-radius:40px;border:0;background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;font-weight:600;box-shadow:0 6px 18px rgba(59,130,246,0.25)}
    .ghost{background:rgba(255,255,255,0.12)}
    .message{position:absolute;left:12px;bottom:120px;background:rgba(255,255,255,0.95);color:#111;padding:10px 12px;border-radius:10px;pointer-events:auto;box-shadow:0 8px 20px rgba(2,6,23,0.08)}
    .page{display:none}
    .page.active{display:block}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    input[type="text"], input[type="number"]{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(16,24,40,0.06);font-size:15px}
    .form-row{margin-top:8px}
    .bottom-actions{display:flex;gap:8px;margin-top:12px}
    .save{flex:1;background:linear-gradient(180deg,var(--accent),var(--accent-dark));color:#fff;border-radius:12px;padding:10px 12px;border:0;font-weight:700;cursor:pointer}
    .secondary{background:transparent;border-radius:12px;padding:10px 12px;border:1px solid rgba(16,24,40,0.06);cursor:pointer}
    ul.local-list{margin:0;padding-left:14px;color:var(--muted);font-size:13px;max-height:120px;overflow:auto}
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Stregkode-scanner</h1>
      <div id="status" class="small" style="margin-bottom:8px">Klar — tryk Start kamera</div>

      <!-- Start page -->
      <div id="page-start" class="page active">
        <div class="card center" style="padding:28px;border-radius:12px;background:#0f1724;color:#fff">
          <div style="text-align:center">
            <div style="font-weight:700;font-size:16px;margin-bottom:12px">Kamera ikke aktiv</div>
            <div class="small" style="opacity:0.9;margin-bottom:20px">Tryk for at starte kameraet og scanne stregkoder</div>
            <button id="startCameraBtn" class="btn">Start kamera</button>
          </div>
        </div>
      </div>

      <!-- Scan page -->
      <div id="page-scan" class="page">
        <div class="stage card" style="padding:0;background:#061123;">
          <video id="video" playsinline muted></video>
          <div class="overlay">
            <div class="topbar">
              <div class="chip" id="chip-barcode"></div>
              <div style="display:flex;gap:8px">
                <div id="barcodeTop" class="chip" style="display:none;pointer-events:none"></div>
                <button id="stopCameraBtn" class="chip" title="Stop kamera" style="pointer-events:auto;background:rgba(255,255,255,0.08)">Stop</button>
              </div>
            </div>

            <div id="scanMessage" class="message" style="display:none">
              <div id="scanStatus">Barcode fundet!</div>
              <!-- note: barcode itself is NOT shown here per request -->
            </div>

            <div id="bottomArea" class="bottom">
              <!-- bottom button area is dynamically filled when code is scanned -->
            </div>
          </div>
        </div>
      </div>

      <!-- Photo preview -->
      <div id="page-photo" class="page">
        <div class="stage card" style="background:#0b1220;padding:0">
          <img id="previewImg" class="preview" src="" alt="Forhåndsvisning" />
          <div class="overlay">
            <div class="topbar">
              <div class="chip">Billede</div>
            </div>
            <div class="bottom">
              <button id="retakeBtn" class="btn ghost" style="margin-right:8px;pointer-events:auto">Tag om</button>
              <button id="acceptPhotoBtn" class="btn" style="pointer-events:auto">Godkend billede</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Edit page -->
      <div id="page-edit" class="page">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
          <div style="flex:0 0 88px">
            <img id="editPreview" src="" alt="Produkt" style="width:88px;height:88px;object-fit:cover;border-radius:10px;border:1px solid rgba(16,24,40,0.04)"/>
          </div>
          <div style="flex:1">
            <div style="font-weight:800" id="editBarcodeLabel">—</div>
            <div class="small" id="editTimestamp">—</div>
          </div>
        </div>

        <label>Produktnavn</label>
        <div class="form-row">
          <input id="field_name" type="text" placeholder="Produktnavn" />
        </div>

        <label>Producent / brand</label>
        <div class="form-row">
          <input id="field_brand" type="text" placeholder="Brand" />
        </div>

        <label>Søgeord</label>
        <div class="form-row">
          <input id="field_category" type="text" placeholder="fx ketchup" />
        </div>

        <label>Placering (hylde)</label>
        <div class="form-row">
          <input id="field_shelf" type="text" placeholder="fx 42" />
        </div>

        <div class="bottom-actions">
          <button id="saveProductBtn" class="save">Gem produkt i Supabase</button>
          <button id="backToScanBtn" class="secondary">Tilbage</button>
        </div>

        <div style="margin-top:12px">
          <div class="small" style="margin-bottom:6px">Lokalt scannede (sidste)</div>
          <ul id="localList" class="local-list"></ul>
        </div>
      </div>

    </div>
  </div>

  <!-- libs -->
  <script src="https://unpkg.com/@zxing/browser@0.1.5"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <script>
    /*******************************
     * --- KONFIGURER SUPABASE ----
     * Udskift disse med dine værdier
     *******************************/
    const SUPABASE_URL = 'https://lpcygniycyffeswzrnms.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxwY3lnbml5Y3lmZmVzd3pybm1zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwODA5NDIsImV4cCI6MjA3MjY1Njk0Mn0.4bVTsLEwvjyPllLU1-U2vcw3yHkzqj69TZOfuJvSvDQ';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /*******************************
     * Elements & state
     *******************************/
    const pageStart = document.getElementById('page-start');
    const pageScan = document.getElementById('page-scan');
    const pagePhoto = document.getElementById('page-photo');
    const pageEdit = document.getElementById('page-edit');
    const statusEl = document.getElementById('status');
    const video = document.getElementById('video');
    const previewImg = document.getElementById('previewImg');
    const editPreview = document.getElementById('editPreview');
    const editBarcodeLabel = document.getElementById('editBarcodeLabel');
    const editTimestamp = document.getElementById('editTimestamp');
    const chipBarcode = document.getElementById('chip-barcode');
    const scanMessage = document.getElementById('scanMessage');
    const scanStatus = document.getElementById('scanStatus');
    const bottomArea = document.getElementById('bottomArea');
    const barcodeTop = document.getElementById('barcodeTop');

    const startCameraBtn = document.getElementById('startCameraBtn');
    const stopCameraBtn = document.getElementById('stopCameraBtn');
    const takePhotoBtnFromScan = null; // dynamic
    const acceptPhotoBtn = document.getElementById('acceptPhotoBtn');
    const retakeBtn = document.getElementById('retakeBtn');
    const backToScanBtn = document.getElementById('backToScanBtn');
    const saveProductBtn = document.getElementById('saveProductBtn');

    const field_name = document.getElementById('field_name');
    const field_brand = document.getElementById('field_brand');
    const field_category = document.getElementById('field_category');
    const field_shelf = document.getElementById('field_shelf');

    const localList = document.getElementById('localList');

    // internal state
    let stream = null;
    let reader = null, controls = null;
    let canvas = document.createElement('canvas');
    let lastScanned = null;
    let currentBarcode = '';
    let openfoodData = null;
    let localProducts = [];
    let detectionPaused = false; // <-- important: pause detection but keep camera stream

    function showPage(el){
      [pageStart,pageScan,pagePhoto,pageEdit].forEach(p=>p.classList.remove('active'));
      el.classList.add('active');
    }
    function setStatus(txt){ statusEl.textContent = txt; }

    /*******************************
     * Camera helpers
     *******************************/
    async function findBackDeviceId(){
      try{ const tmp = await navigator.mediaDevices.getUserMedia({video:true}); tmp.getTracks().forEach(t=>t.stop()); }catch(e){}
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(d=>d.kind==='videoinput');
      const back = videoDevices.find(d=>/back|rear|environment/i.test(d.label));
      return back ? back.deviceId : (videoDevices.length ? videoDevices[videoDevices.length-1].deviceId : null);
    }

    async function startCamera(){
      showPage(pageScan);
      setStatus('Starter kamera — tillad adgang');
      detectionPaused = false;
      try{
        const deviceId = await findBackDeviceId();
        if(deviceId){
          stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId }, width: { ideal: 1280 } } });
        } else {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } } });
        }
        video.srcObject = stream;
        await video.play();
        setStatus('Scanner efter stregkoder...');
        // clear bottom area (no hold button initially)
        clearBottomButton();
        runDetectionLoop();
      }catch(e){
        console.error(e);
        setStatus('Fejl ved kameraadgang — tjek tilladelser og HTTPS');
        showPage(pageStart);
      }
    }

    function stopCamera(){
      // do not stop simply because a barcode was found — user must stop or accept/retake
      try{ if(controls && typeof controls.stop==='function') controls.stop(); }catch(e){}
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      detectionPaused = true;
      clearBottomButton();
      barcodeTop.style.display = 'none';
      showPage(pageStart);
      setStatus('Kamera stoppet');
    }

    /*******************************
     * Detection loop (native BarcodeDetector or ZXing fallback)
     * We respect detectionPaused: we DO NOT stop camera; we only ignore detections.
     *******************************/
    async function runDetectionLoop(){
      scanMessage.style.display = 'none';
      chipBarcode.textContent = 'Hold kamera over stregkoden';
      barcodeTop.style.display = 'none';
      detectionPaused = false;

      if('BarcodeDetector' in window){
        try{
          const detector = new BarcodeDetector({ formats: ['ean_13','ean_8','upc_a','upc_e','code_128','code_39'] });
          const ctx = canvas.getContext('2d');
          (async function loop(){
            if(!stream) return;
            try{
              if(!detectionPaused){
                canvas.width = video.videoWidth || 640; canvas.height = video.videoHeight || 480;
                ctx.drawImage(video,0,0,canvas.width,canvas.height);
                const codes = await detector.detect(canvas);
                if(codes && codes.length){
                  const code = codes[0].rawValue || codes[0].raw_text || '';
                  if(code) await handleBarcode(code);
                }
              }
            }catch(e){}
            requestAnimationFrame(loop);
          })();
          return;
        }catch(e){
          console.warn('BarcodeDetector fejl — fallback', e);
        }
      }

      // ZXing fallback: ignore detections while detectionPaused === true
      if(window.ZXingBrowser){
        reader = new ZXingBrowser.BrowserMultiFormatReader();
        const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
        const chosen = (devices.find(d=>/back|rear|environment/i.test(d.label)) || devices[devices.length-1] || devices[0]);
        controls = await reader.decodeFromVideoDevice(chosen.deviceId, video, async (result, err, ctrl) => {
          try{
            if(detectionPaused) return; // ignore while paused
            if(result && result.text) await handleBarcode(result.text);
          }catch(e){}
        });
      } else {
        setStatus('Ingen barcode-detektor tilgængelig');
      }
    }

    /*******************************
     * When barcode is found
     *******************************/
    async function handleBarcode(code){
      // debounce same code quickly
      if(currentBarcode === code && Date.now() - (lastScanned?.time || 0) < 1200) return;
      lastScanned = { code, time: Date.now() };
      currentBarcode = code;

      // pause detection (but keep stream running)
      detectionPaused = true;

      // show small message (no barcode here)
      scanStatus.textContent = 'Stregkode fundet — tag et billede';
      scanMessage.style.display = 'block';

      // show code up top beside stop button
      barcodeTop.textContent = code;
      barcodeTop.style.display = 'inline-flex';

      // show bottom "Tag billede" button (in same position as previous hold-knap)
      showBottomPhotoButton();

      // fill edit header values
      editBarcodeLabel.textContent = code;
      editTimestamp.textContent = new Date().toLocaleString();

      // clear previous OFF data & preview
      openfoodData = null;
      editPreview.src = '';
      previewImg.src = '';

      // Fetch OpenFoodFacts to autofill name/brand (but DO NOT use their image)
      try{
        const r = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
        if(r.ok){
          const j = await r.json();
          if(j.status === 1){
            openfoodData = j.product;
            field_name.value = j.product.product_name_da || j.product.product_name || field_name.value || '';
            field_brand.value = (j.product.brands || field_brand.value || '');
            field_category.value = (j.product.categories_tags?.[0]||field_category.value||'').replace('en:','').replace(/-/g,' ');
            setStatus('Produktforslag hentet fra OpenFoodFacts');
          } else {
            setStatus('Ingen info i OpenFoodFacts');
          }
        }
      }catch(e){
        console.warn('OFF fejl', e);
        setStatus('OFF: kunne ikke hente info');
      }
    }

    /*******************************
     * Bottom area helpers (dynamisk Tag billede knap)
     *******************************/
    function clearBottomButton(){
      bottomArea.innerHTML = '';
    }

    function showBottomPhotoButton(){
      clearBottomButton();
      const btn = document.createElement('button');
      btn.id = 'dynamicTakePhoto';
      btn.className = 'btn ghost';
      btn.style.pointerEvents = 'auto';
      btn.textContent = 'Tag billede';
      btn.addEventListener('click', () => {
        // take snapshot for preview (but keep stream on until user accepts/retake)
        takeSnapshotForPreview();
      });
      bottomArea.appendChild(btn);
    }

    /*******************************
     * Snapshot & preview
     *******************************/
    function takeSnapshotForPreview(){
      if(!stream){
        setStatus('Intet kamera aktivt');
        return;
      }
      setStatus('Tager billede...');
      canvas.width = video.videoWidth || 1280;
      canvas.height = video.videoHeight || 720;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      previewImg.src = canvas.toDataURL('image/jpeg', 0.85);
      // navigate to preview page (camera still running)
      showPage(pagePhoto);
      setStatus('Forhåndsvisning — godkend eller tag om');
    }

    // accept -> go to edit page and stop camera to save resources
    acceptPhotoBtn.addEventListener('click', () => {
      editPreview.src = previewImg.src || '';
      editBarcodeLabel.textContent = currentBarcode || editBarcodeLabel.textContent || '—';
      editTimestamp.textContent = new Date().toLocaleString();
      // stop the stream now (the user decided)
      try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } }catch(e){}
      detectionPaused = true;
      clearBottomButton();
      showPage(pageEdit);
      setStatus('Rediger produktinfo');
    });

    // retake: go back to scan and restart detection (camera may already be active)
    retakeBtn.addEventListener('click', async () => {
      // if camera is stopped, start it again; otherwise just resume detection
      if(!stream){
        await startCamera();
      } else {
        detectionPaused = false;
        scanMessage.style.display = 'none';
        barcodeTop.style.display = 'none';
        clearBottomButton();
        setStatus('Scanner efter stregkoder...');
      }
      showPage(pageScan);
    });

    /*******************************
     * Save product to Supabase
     *******************************/
    saveProductBtn.addEventListener('click', async () => {
      const barcode = editBarcodeLabel.textContent;
      const name = field_name.value.trim();
      const brand = field_brand.value.trim();
      const category = field_category.value.trim();
      const shelf = field_shelf.value.trim();
      const image_preview = editPreview.src || null;

      if(!barcode || !name || !brand){
        alert('Udfyld venligst stregkode, navn og brand.');
        return;
      }

      const productData = {
        barcode,
        name,
        brand,
        category,
        shelf,
        image_preview
      };

      setStatus('Gemmer til Supabase...');
      try{
        const { data, error } = await supabase
          .from('products')
          .insert([productData]);

        if(error){
          console.error('Supabase insert error:', error);
          setStatus('Fejl ved gemning: ' + (error.message || 'ukendt fejl'));
          return;
        }

        setStatus('Produkt gemt i Supabase ✅');
        // also keep a local copy for quick list
        localProducts.push(Object.assign({ created_at: new Date().toISOString() }, productData));
        renderLocalList();

        // reset UI
        field_name.value = '';
        field_brand.value = '';
        field_category.value = '';
        field_shelf.value = '';
        editPreview.src = '';
        editBarcodeLabel.textContent = '—';
        editTimestamp.textContent = '—';
        currentBarcode = '';
        showPage(pageStart);
      }catch(e){
        console.error(e);
        setStatus('Fejl ved gemning: ' + (e.message || e));
      }
    });

    function renderLocalList(){
      localList.innerHTML = '';
      [...localProducts].reverse().slice(0,20).forEach(p => {
        const li = document.createElement('li');
        li.textContent = `${p.barcode} • ${p.brand || '-'} • H:${p.shelf || '-'} • ${p.name || '-'}`;
        localList.appendChild(li);
      });
    }

    /*******************************
     * One-shot "hold to scan" removed — user uses Tag billede when barcode found
     *******************************/

    // Start/Stop buttons
    startCameraBtn.addEventListener('click', startCamera);
    stopCameraBtn.addEventListener('click', stopCamera);
    backToScanBtn.addEventListener('click', async () => {
      // go back to scanning: restart camera
      await startCamera();
    });

    // stop camera on page hide
    window.addEventListener('pagehide', () => {
      try{ if(controls && typeof controls.stop==='function') controls.stop(); }catch(e){}
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      detectionPaused = true;
    });

    // initial state
    showPage(pageStart);
    setStatus('Klar — tryk Start kamera');
  </script>
</body>
</html>
