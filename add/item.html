<!doctype html>
<html lang="da">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stregkode-scanner</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#111}
    body{max-width:780px;margin:16px auto;padding:12px;display:flex;flex-direction:column;gap:12px}
    header{display:flex;justify-content:space-between;align-items:center}
    h1{font-size:18px;margin:0}
    video{width:100%;border-radius:10px;background:#000}
    button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:#f6f6f6}
    button.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    button.toggle{margin-left:6px;font-size:12px}
    button.toggle.active{background:#2563eb;color:#fff;border-color:#2563eb}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .status{padding:8px;border-radius:8px;background:#eef3ff;min-height:38px}
    .panel{display:grid;grid-template-columns:1fr 300px;gap:12px}
    .right{border-left:1px solid #eee;padding-left:12px}
    label{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-size:13px}
    input{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd}
    ul{padding-left:18px;margin-top:8px}
    @media (max-width:760px){.panel{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <h1>Stregkode-scanner</h1>
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="saveBtn" class="primary" disabled>Gem</button>
  </div>
</header>

<div class="status" id="status">Klar</div>

<div class="panel">
  <div>
    <video id="video" playsinline muted></video>
    <canvas id="canvas" style="display:none"></canvas>
  </div>

  <div class="right">
    <label>Stregkode</label>
    <input id="barcodeInput" readonly />

    <label>Produktnavn</label>
    <input id="nameInput" />

    <label>Kategori</label>
    <input id="categoryInput" />

    <label>
      Hylde
      <button id="lockShelf" class="toggle">Gem værdi</button>
    </label>
    <input id="shelfInput" placeholder="fx 3" />

    <label>
      Række
      <button id="lockRow" class="toggle">Gem værdi</button>
    </label>
    <input id="rowInput" placeholder="fx B" />

    <label>Oprettelsesdato</label>
    <input id="dateInput" readonly />

    <label>Lokalt scannede</label>
    <ul id="list"></ul>
  </div>
</div>

<script src="https://unpkg.com/@zxing/browser@0.1.5"></script>
<script>
const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
const SUPABASE_TABLE = 'products';

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const saveBtn = document.getElementById('saveBtn');
const barcodeInput = document.getElementById('barcodeInput');
const nameInput = document.getElementById('nameInput');
const categoryInput = document.getElementById('categoryInput');
const shelfInput = document.getElementById('shelfInput');
const rowInput = document.getElementById('rowInput');
const dateInput = document.getElementById('dateInput');
const listEl = document.getElementById('list');
const statusEl = document.getElementById('status');
const lockShelfBtn = document.getElementById('lockShelf');
const lockRowBtn = document.getElementById('lockRow');

let stream=null, reader=null, controls=null;
let lastScanned=null;
let localProducts=[];
let lockShelf=false, lockRow=false;
let savedShelf=null, savedRow=null;

function setStatus(t){statusEl.textContent=t}

lockShelfBtn.onclick=()=>{
  lockShelf=!lockShelf;
  lockShelfBtn.classList.toggle('active',lockShelf);
  savedShelf = lockShelf ? shelfInput.value : null;
};
lockRowBtn.onclick=()=>{
  lockRow=!lockRow;
  lockRowBtn.classList.toggle('active',lockRow);
  savedRow = lockRow ? rowInput.value : null;
};

startBtn.onclick=startScanning;
stopBtn.onclick=stopScanning;
saveBtn.onclick=saveProduct;

async function startScanning(){
  // stop evt. tidligere ting
  try{ if(controls && typeof controls.stop === 'function') controls.stop(); }catch(e){}
  try{ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream = null; } }catch(e){}

  startBtn.disabled = true;
  setStatus('Starter kamera — tillad venligst adgang');

  // Hjælpefunktion: hent et back-kamera deviceId hvis muligt
  async function findBackDeviceId(){
    try{
      // Sørg for at vi har tilladelse så labels udfyldes
      const tmp = await navigator.mediaDevices.getUserMedia({ video: true });
      tmp.getTracks().forEach(t=>t.stop());
    }catch(e){
      // Ignorer fejl her — vi prøver andre ting senere
    }

    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d => d.kind === 'videoinput');

    // Forsøg at finde enhed med 'back|rear|environment' i label
    const back = videoDevices.find(d => /back|rear|environment/i.test(d.label));
    if(back) return back.deviceId;

    // Hvis ikke, returner sidste video-enhed (ofte bagkamera på mange mobiler)
    return videoDevices.length ? videoDevices[videoDevices.length - 1].deviceId : null;
  }

  try{
    let deviceId = null;
    try{ deviceId = await findBackDeviceId(); }catch(e){ deviceId = null; }

    // Hvis vi fik et deviceId, brug det. Ellers prøv facingMode fallback.
    if(deviceId){
      stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId }, width: { ideal: 1280 } } });
    }else{
      // Fallback: prøv at bede om environment (kan stadig fejle på nogle browsere)
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 } } });
    }

    video.srcObject = stream;
    await video.play();
    stopBtn.disabled = false;
    setStatus('Scanner...');

    // Start BarcodeDetector eller ZXing som før
    if('BarcodeDetector' in window){
      try{
        const formats = ['ean_13','ean_8','upc_a','upc_e','code_128','code_39','qr_code'];
        const detector = new BarcodeDetector({ formats });
        const ctx = canvas.getContext('2d');
        const loop = async () => {
          if(!stream) return;
          try{
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            ctx.drawImage(video,0,0,canvas.width,canvas.height);
            const barcodes = await detector.detect(canvas);
            if(barcodes && barcodes.length){
              const code = barcodes[0].rawValue || barcodes[0].raw_text || '';
              if(code) handleBarcode(code);
            }
          }catch(e){}
          requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);
        return;
      }catch(e){ console.warn('BarcodeDetector fejl – fallback til ZXing', e); }
    }

    // ZXing fallback
    if(window.ZXingBrowser){
      try{
        reader = new ZXingBrowser.BrowserMultiFormatReader();
        const devices = await ZXingBrowser.BrowserCodeReader.listVideoInputDevices();
        // Prøv at bruge samme deviceId hvis muligt, ellers fall back
        let chosen = devices.find(d => d.deviceId === deviceId) || devices.find(d => /back|rear|environment/i.test(d.label)) || devices[0];
        controls = await reader.decodeFromVideoDevice(chosen.deviceId, video, (result, err) => {
          if(result) handleBarcode(result.text);
        });
        return;
      }catch(e){ console.warn('ZXing decode fejl', e); }
    }

    setStatus('Ingen scanner tilgængelig på denne enhed');
    startBtn.disabled = false;
  }catch(err){
    console.error(err);
    setStatus('Fejl ved kameraadgang — tjek tilladelser og HTTPS');
    startBtn.disabled = false;
  }
}


async function handleBarcode(code){
  if(lastScanned&&lastScanned.code===code&&Date.now()-lastScanned.time<1500) return;
  lastScanned={code,time:Date.now()};
  barcodeInput.value=code;
  dateInput.value=new Date().toLocaleString();
  saveBtn.disabled=false;

  if(lockShelf && savedShelf) shelfInput.value=savedShelf;
  if(lockRow && savedRow) rowInput.value=savedRow;

  try{
    const r=await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
    const j=await r.json();
    if(j.status===1){
      nameInput.value=j.product.product_name_da||j.product.product_name||'';
      categoryInput.value=(j.product.categories_tags?.[0]||'').replace('en:','').replace(/-/g,' ');
      setStatus('Produkt fundet');
      return;
    }
  }catch{}
  setStatus('Ingen info fundet');
}

function renderList(){
  listEl.innerHTML='';
  localProducts.forEach(p=>{
    const li=document.createElement('li');
    li.textContent=`${p.barcode} | H${p.shelf||'-'} R${p.row||'-'} | ${p.name||''}`;
    listEl.appendChild(li);
  });
}

async function saveProduct(){
  const p={
    barcode:barcodeInput.value,
    name:nameInput.value||null,
    category:categoryInput.value||null,
    shelf:shelfInput.value||null,
    row:rowInput.value||null,
    created_at:new Date().toISOString()
  };
  localProducts.push(p);
  renderList();
  setStatus('Gemt lokalt');

  if(localProducts.length>=10){
    if(confirm('Du har 10+ produkter lokalt. Vil du uploade til Supabase nu?')){
      await uploadAll();
    }
  }
}

async function uploadAll(){
  setStatus('Uploader...');
  const res=await fetch(`${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}`,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'apikey':SUPABASE_ANON_KEY,
      'Authorization':'Bearer '+SUPABASE_ANON_KEY
    },
    body:JSON.stringify(localProducts)
  });
  if(res.ok){
    localProducts=[]; renderList(); setStatus('Upload færdig ✔');
  }else{
    setStatus('Upload-fejl');
  }
}

function stopScanning(){
  if(controls) controls.stop();
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null}
  startBtn.disabled=false; stopBtn.disabled=true; setStatus('Stoppet');
}
</script>
</body>
</html>
